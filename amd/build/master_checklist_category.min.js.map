{"version":3,"file":"master_checklist_category.min.js","sources":["../src/master_checklist_category.js"],"sourcesContent":["import { BaseComponent, DragDrop } from 'core/reactive';\r\nimport { masterChecklistReactiveInstance } from 'mod_bookit/master_checklist_reactive';\r\nimport { SELECTORS } from 'mod_bookit/master_checklist_reactive';\r\nimport ModalForm from 'core_form/modalform';\r\nimport {getString} from 'core/str';\r\n\r\nexport default class extends BaseComponent {\r\n\r\n    create(descriptor) {\r\n\r\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + descriptor.element.dataset.bookitCategoryId;\r\n\r\n        this.selectors[categoryEditBtnSelector] = `#edit-checklistcategory-${descriptor.element.dataset.bookitCategoryId}`;\r\n\r\n        const categoryTbodySelector = 'CATEGORY_TBODY_' + descriptor.element.dataset.bookitCategoryId;\r\n        this.selectors[categoryTbodySelector] = `#bookit-master-checklist-tbody-category-${descriptor.element.dataset.bookitCategoryId}`;\r\n    }\r\n\r\n    static init(target, selectors) {\r\n        return new this({\r\n            element: document.querySelector(target),\r\n            reactive: masterChecklistReactiveInstance,\r\n            selectors: selectors || SELECTORS,\r\n        });\r\n    }\r\n\r\n    getWatchers() {\r\n        return [\r\n            {watch: 'checklistcategories.name:updated', handler: this._refreshEditButtonListener},\r\n        ];\r\n    }\r\n\r\n    stateReady(state) {\r\n\r\n        this.dragdrop = new DragDrop(this);\r\n\r\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + this.element.dataset.bookitCategoryId;\r\n\r\n        this.addEventListener(this.getElement(this.selectors[categoryEditBtnSelector]), 'click', (e) => {\r\n            e.preventDefault();\r\n            window.console.log('EDIT CHECKLIST CATEGORY BUTTON CLICKED', e.currentTarget);\r\n            this._handleEditChecklistCategoryButtonClick(e);\r\n        });\r\n\r\n        document.addEventListener('mod_bookit:master_checklist_category_rendered', (e) => {\r\n\r\n            this._refreshEditButtonListener(e);\r\n        }, true);\r\n    }\r\n\r\n    destroy() {\r\n        if (this.dragdrop !== undefined) {\r\n            this.dragdrop.unregister();\r\n        }\r\n    }\r\n\r\n    validateDropData(dropdata) {\r\n        return true;\r\n    }\r\n\r\n    async _handleEditChecklistCategoryButtonClick(event) {\r\n        const modalForm = new ModalForm({\r\n            formClass: 'mod_bookit\\\\form\\\\edit_checklist_category_form',\r\n            moduleName: 'mod_bookit/modal_delete_save_cancel',\r\n            args: {\r\n                id: this.element.dataset.bookitCategoryId,\r\n                masterid: 1,\r\n                checklistitems: JSON.stringify(this.reactive.state.checklistcategories.get(this.element.dataset.bookitCategoryId).items),\r\n            },\r\n            modalConfig: {\r\n                title: await getString('checklistcategory', 'mod_bookit'),\r\n            },\r\n        })\r\n\r\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (response) => {\r\n            this.reactive.stateManager.processUpdates(response.detail);\r\n        });\r\n\r\n        modalForm.addEventListener(modalForm.events.LOADED, (response) => {\r\n\r\n            const deleteButton = modalForm.modal.getRoot().find('button[data-action=\"delete\"]');\r\n\r\n            deleteButton.on('click', (e) => {\r\n                modalForm.getFormNode().querySelector('input[name=\"action\"]').value = 'delete';\r\n                modalForm.submitFormAjax();\r\n            });\r\n        });\r\n\r\n        modalForm.show();\r\n    };\r\n\r\n    _refreshEditButtonListener(event) {\r\n        this.removeAllEventListeners();\r\n\r\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + this.element.dataset.bookitCategoryId;\r\n\r\n        this.addEventListener(this.getElement(this.selectors[categoryEditBtnSelector]), 'click', (e) => {\r\n            e.preventDefault();\r\n            this._handleEditChecklistCategoryButtonClick(e);\r\n        });\r\n    }\r\n\r\n    drop(dropdata, event) {\r\n        switch (dropdata.type) {\r\n            case 'item':\r\n                this._handleItemDrop(dropdata, event);\r\n                break;\r\n            case 'category':\r\n                this._handleCategoryDrop(dropdata, event);\r\n                break;\r\n            default:\r\n                throw new Error(`Unknown drop type: ${dropdata.type}`);\r\n        }\r\n    }\r\n\r\n    showDropZone(dropdata, event) {\r\n        const root = document.querySelector('html');\r\n        const primaryColor = getComputedStyle(root).getPropertyValue('--primary');\r\n\r\n        this.element.style.boxShadow = `0px -5px 0px 0px ${primaryColor} inset`;\r\n        this.element.style.transition = 'box-shadow 0.1s ease';\r\n    }\r\n\r\n    hideDropZone(dropdata, event) {\r\n        this.element.style.boxShadow = '';\r\n        this.element.style.backgroundBlendMode = '';\r\n        this.element.style.transition = '';\r\n    }\r\n\r\n    _handleItemDrop(dropdata, event) {\r\n\r\n        const categoryObject = this.reactive.state.checklistcategories.get(this.element.dataset.bookitCategoryId);\r\n\r\n        const categoryObjectItems = [...categoryObject.items];\r\n\r\n        const lastItemId = categoryObjectItems[categoryObjectItems.length - 1];\r\n\r\n        dropdata.targetId = parseInt(lastItemId);\r\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitCategoryId);\r\n\r\n        this.reactive.dispatch('reOrderCategoryItems', dropdata);\r\n\r\n        const itemObject = this.reactive.state.checklistitems.get(dropdata.id);\r\n\r\n        const itemElement = document.getElementById(`bookit-master-checklist-item-${itemObject.id}`);\r\n\r\n        const itemHasChangedParent = dropdata.parentId !== dropdata.targetParentId;\r\n\r\n        if (itemHasChangedParent) {\r\n            itemElement.dataset.bookitChecklistitemCategoryid = dropdata.targetParentId;\r\n        }\r\n\r\n        this.element.append(itemElement);\r\n    }\r\n\r\n\r\n    _handleCategoryDrop(dropdata, event) {\r\n\r\n        dropdata.targetId = parseInt(this.element.dataset.bookitCategoryId);\r\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitCategoryMasterid);\r\n\r\n        this.reactive.dispatch('reOrderCategories', dropdata);\r\n\r\n        const categoryObject = this.reactive.state.checklistcategories.get(dropdata.id);\r\n\r\n        const categoryElement = document.getElementById(`bookit-master-checklist-tbody-category-${categoryObject.id}`);\r\n\r\n        const tableElement = document.querySelector(this.selectors.TABLE);\r\n\r\n        tableElement.insertBefore(categoryElement, this.element.nextElementSibling);\r\n\r\n    }\r\n\r\n}"],"names":["BaseComponent","create","descriptor","categoryEditBtnSelector","element","dataset","bookitCategoryId","selectors","categoryTbodySelector","target","this","document","querySelector","reactive","masterChecklistReactiveInstance","SELECTORS","getWatchers","watch","handler","_refreshEditButtonListener","stateReady","state","dragdrop","DragDrop","addEventListener","getElement","e","preventDefault","window","console","log","currentTarget","_handleEditChecklistCategoryButtonClick","destroy","undefined","unregister","validateDropData","dropdata","event","modalForm","ModalForm","formClass","moduleName","args","id","masterid","checklistitems","JSON","stringify","checklistcategories","get","items","modalConfig","title","events","FORM_SUBMITTED","response","stateManager","processUpdates","detail","LOADED","modal","getRoot","find","on","getFormNode","value","submitFormAjax","show","removeAllEventListeners","drop","type","_handleItemDrop","_handleCategoryDrop","Error","showDropZone","root","primaryColor","getComputedStyle","getPropertyValue","style","boxShadow","transition","hideDropZone","backgroundBlendMode","categoryObjectItems","lastItemId","length","targetId","parseInt","targetParentId","dispatch","itemObject","itemElement","getElementById","parentId","bookitChecklistitemCategoryid","append","bookitCategoryMasterid","categoryObject","categoryElement","TABLE","insertBefore","nextElementSibling"],"mappings":"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"}