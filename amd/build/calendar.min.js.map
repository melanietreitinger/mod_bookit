{"version":3,"file":"calendar.min.js","sources":["../src/calendar.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Manage the calendar\n *\n * @module     mod_bookit/calendar\n * @copyright  2024 Melanie Treitinger, Justus Dieckmann RUB\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getString} from 'core/str';\nimport ModalForm from 'core_form/modalform';\nimport {prefetchStrings} from 'core/prefetch';\nimport {initPossibleStarttimesRefresh} from \"mod_bookit/possible_slots_refresh\";\n\nexport const theGlobalProperty = (globalPropertyName) => {\n    return new Promise((resolve) => {\n       const innerWait = () => {\n           if (!window[globalPropertyName]) {\n               setTimeout(innerWait, 20);\n           }\n           resolve();\n       };\n       innerWait();\n    });\n};\n\n/**\n * Initializes the calendar.\n * @param {int} cmid\n * @param {string} eventsource\n * @param {array} capabilities\n * @param {string} lang\n * @param {array} config\n * @returns {Promise<void>}\n */\nexport async function init(cmid, eventsource, capabilities, lang, config) {\n    await theGlobalProperty('EventCalendar');\n\n    // Set textcolor.\n    let textcolor = '#ffffff';\n    if (Object.hasOwn(config, 'textcolor')) {\n        textcolor = config.textcolor;\n    }\n\n    // Define toolbarbuttons.\n    let toolbarbuttons = 'prev,next today';\n    if (capabilities.addevent) {\n        toolbarbuttons = 'prev,next today, addButton';\n    }\n\n    // String variables.\n    prefetchStrings('mod_bookit', ['addbooking']);\n    prefetchStrings('core', ['today', 'month', 'week']);\n    prefetchStrings('calendar', ['day', 'upcomingevents']);\n    const str_request_booking   = await getString('addbooking', 'mod_bookit');\n    const str_today             = await getString('today');\n    const str_month             = await getString('month');\n    const str_week              = await getString('week');\n    const str_day               = await getString('day', 'calendar');\n    const str_list              = await getString('upcomingevents', 'calendar');\n    /*const str_request_booking = 'XXX';\n    const str_today             = 'XXX';\n    const str_month             = 'XXX';\n    const str_week              = 'XXX';\n    const str_day               = 'XXX';\n    const str_list              = 'XXX';*/\n\n    // Define viewtype.\n    let viewType = 'timeGridWeek';\n    if (window.screen.width <= 1000) {\n        viewType = 'listWeek';\n    }\n\n    var calendar;\n\n    calendar = new window.EventCalendar(document.getElementById('ec'), {\n        locale: lang,\n        view: viewType,\n        firstDay: 1,\n        scrollTime: '09:00:00',\n        slotMinTime: '07:00:00',\n        dayMaxEvents: true,\n        nowIndicator: true,\n        selectable: false,\n        eventTextColor: textcolor,\n        eventBackgroundColor: '#035AA3',\n        eventStartEditable: false,\n        eventDurationEditable: false,\n        buttonText: function (text) {\n            text.today = str_today;\n            text.dayGridMonth = str_month;\n            text.timeGridWeek = str_week;\n            text.timeGridDay = str_day;\n            text.listWeek = str_list;\n            return text;\n        },\n        customButtons: {\n            addButton: {\n                text: str_request_booking,\n                click: function() {\n                    const modalForm = new ModalForm({\n                                    formClass: \"mod_bookit\\\\form\\\\edit_event_form\",\n                                    args: {\n                                        cmid: cmid,\n                                    },\n                                    modalConfig: {title: getString('edit_event', 'mod_bookit')},\n                                });\n                                modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n                                    calendar.refetchEvents();\n                                });\n                                modalForm.addEventListener(modalForm.events.LOADED, initPossibleStarttimesRefresh);\n                                modalForm.show();\n                }\n            }\n        },\n        dateClick: function(info) {\n            let d = new Date();\n            let dateoff = new Date(d.setMinutes(d.getMinutes() - d.getTimezoneOffset()));\n            let startdate = info.dateStr;\n            if (capabilities.addevent && startdate > dateoff.toISOString()) {\n                const modalForm = new ModalForm({\n                    formClass: \"mod_bookit\\\\form\\\\edit_event_form\",\n                    args: {\n                        cmid: cmid,\n                        timeclicked: startdate,\n                    },\n                    modalConfig: {title: getString('edit_event', 'mod_bookit')},\n                });\n                modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n                    calendar.refetchEvents();\n                });\n                modalForm.addEventListener(modalForm.events.LOADED, initPossibleStarttimesRefresh);\n                modalForm.show();\n            }\n        },\n        eventClick: function (info) {\n            let id = info.event.id;\n\n            if (!info.event.extendedProps.reserved) {\n                const modalForm = new ModalForm({\n                    formClass: \"mod_bookit\\\\form\\\\edit_event_form\",\n                    args: {\n                        cmid: cmid,\n                        id: id,\n                    },\n                    modalConfig: {title: getString('edit_event', 'mod_bookit')},\n                });\n                modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n                    calendar.refetchEvents();\n                });\n                modalForm.addEventListener(modalForm.events.LOADED, initPossibleStarttimesRefresh);\n                modalForm.show();\n            }\n        },\n        headerToolbar: {\n            start: toolbarbuttons,\n            center: 'title',\n            end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'\n        },\n        resources: [],\n        eventSources: [\n            {\n                url: eventsource,\n            },\n        ],\n        views: {\n            timeGridWeek: {pointer: true},\n            resourceTimeGridWeek: {pointer: true},\n            resourceTimelineWeek: {\n                pointer: true,\n                slotMinTime: '09:00',\n                slotMaxTime: '21:00',\n                slotWidth: 80,\n                resources: []\n            }\n        },\n    });\n}\n"],"names":["cmid","eventsource","capabilities","lang","config","theGlobalProperty","textcolor","Object","hasOwn","toolbarbuttons","addevent","str_request_booking","str_today","str_month","str_week","str_day","str_list","viewType","window","screen","width","calendar","EventCalendar","document","getElementById","locale","view","firstDay","scrollTime","slotMinTime","dayMaxEvents","nowIndicator","selectable","eventTextColor","eventBackgroundColor","eventStartEditable","eventDurationEditable","buttonText","text","today","dayGridMonth","timeGridWeek","timeGridDay","listWeek","customButtons","addButton","click","modalForm","ModalForm","formClass","args","modalConfig","title","addEventListener","events","FORM_SUBMITTED","refetchEvents","LOADED","initPossibleStarttimesRefresh","show","dateClick","info","d","Date","dateoff","setMinutes","getMinutes","getTimezoneOffset","startdate","dateStr","toISOString","timeclicked","eventClick","id","event","extendedProps","reserved","headerToolbar","start","center","end","resources","eventSources","url","views","pointer","resourceTimeGridWeek","resourceTimelineWeek","slotMaxTime","slotWidth","globalPropertyName","Promise","resolve","innerWait","setTimeout"],"mappings":";;;;;;;0FAiD2BA,KAAMC,YAAaC,aAAcC,KAAMC,cACxDC,kBAAkB,qBAGpBC,UAAY,UACZC,OAAOC,OAAOJ,OAAQ,eACtBE,UAAYF,OAAOE,eAInBG,eAAiB,kBACjBP,aAAaQ,WACbD,eAAiB,4DAIL,aAAc,CAAC,6CACf,OAAQ,CAAC,QAAS,QAAS,uCAC3B,WAAY,CAAC,MAAO,yBAC9BE,0BAA8B,kBAAU,aAAc,cACtDC,gBAA8B,kBAAU,SACxCC,gBAA8B,kBAAU,SACxCC,eAA8B,kBAAU,QACxCC,cAA8B,kBAAU,MAAO,YAC/CC,eAA8B,kBAAU,iBAAkB,gBAS5DC,SAAW,eACXC,OAAOC,OAAOC,OAAS,MACvBH,SAAW,gBAGXI,SAEJA,SAAW,IAAIH,OAAOI,cAAcC,SAASC,eAAe,MAAO,CAC/DC,OAAQtB,KACRuB,KAAMT,SACNU,SAAU,EACVC,WAAY,WACZC,YAAa,WACbC,cAAc,EACdC,cAAc,EACdC,YAAY,EACZC,eAAgB3B,UAChB4B,qBAAsB,UACtBC,oBAAoB,EACpBC,uBAAuB,EACvBC,WAAY,SAAUC,aAClBA,KAAKC,MAAQ3B,UACb0B,KAAKE,aAAe3B,UACpByB,KAAKG,aAAe3B,SACpBwB,KAAKI,YAAc3B,QACnBuB,KAAKK,SAAW3B,SACTsB,MAEXM,cAAe,CACXC,UAAW,CACPP,KAAM3B,oBACNmC,MAAO,iBACGC,UAAY,IAAIC,mBAAU,CAChBC,UAAW,oCACXC,KAAM,CACFlD,KAAMA,MAEVmD,YAAa,CAACC,OAAO,kBAAU,aAAc,iBAEjDL,UAAUM,iBAAiBN,UAAUO,OAAOC,gBAAgB,KACxDlC,SAASmC,mBAEbT,UAAUM,iBAAiBN,UAAUO,OAAOG,OAAQC,uDACpDX,UAAUY,UAIlCC,UAAW,SAASC,UACZC,EAAI,IAAIC,KACRC,QAAU,IAAID,KAAKD,EAAEG,WAAWH,EAAEI,aAAeJ,EAAEK,sBACnDC,UAAYP,KAAKQ,WACjBnE,aAAaQ,UAAY0D,UAAYJ,QAAQM,cAAe,OACtDvB,UAAY,IAAIC,mBAAU,CAC5BC,UAAW,oCACXC,KAAM,CACFlD,KAAMA,KACNuE,YAAaH,WAEjBjB,YAAa,CAACC,OAAO,kBAAU,aAAc,iBAEjDL,UAAUM,iBAAiBN,UAAUO,OAAOC,gBAAgB,KACxDlC,SAASmC,mBAEbT,UAAUM,iBAAiBN,UAAUO,OAAOG,OAAQC,uDACpDX,UAAUY,SAGlBa,WAAY,SAAUX,UACdY,GAAKZ,KAAKa,MAAMD,OAEfZ,KAAKa,MAAMC,cAAcC,SAAU,OAC9B7B,UAAY,IAAIC,mBAAU,CAC5BC,UAAW,oCACXC,KAAM,CACFlD,KAAMA,KACNyE,GAAIA,IAERtB,YAAa,CAACC,OAAO,kBAAU,aAAc,iBAEjDL,UAAUM,iBAAiBN,UAAUO,OAAOC,gBAAgB,KACxDlC,SAASmC,mBAEbT,UAAUM,iBAAiBN,UAAUO,OAAOG,OAAQC,uDACpDX,UAAUY,SAGlBkB,cAAe,CACXC,MAAOrE,eACPsE,OAAQ,QACRC,IAAK,kDAETC,UAAW,GACXC,aAAc,CACV,CACIC,IAAKlF,cAGbmF,MAAO,CACH3C,aAAc,CAAC4C,SAAS,GACxBC,qBAAsB,CAACD,SAAS,GAChCE,qBAAsB,CAClBF,SAAS,EACTxD,YAAa,QACb2D,YAAa,QACbC,UAAW,GACXR,UAAW,8GA/Jd5E,kBAAqBqF,oBACvB,IAAIC,SAASC,gBACXC,UAAY,KACT3E,OAAOwE,qBACRI,WAAWD,UAAW,IAE1BD,WAEJC"}