{"version":3,"file":"calendar.min.js","sources":["../src/calendar.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Manage the calendar\n *\n * @module     mod_bookit/calendar\n * @copyright  2024 Melanie Treitinger, Justus Dieckmann RUB\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getString} from 'core/str';\nimport ModalForm from 'core_form/modalform';\nimport {prefetchStrings} from 'core/prefetch';\nimport {initPossibleStarttimesRefresh} from \"mod_bookit/possible_slots_refresh\";\n\n/**\n * Wait until a global property exists (EventCalendar is loaded asynchronously).\n *\n * @param {String} globalPropertyName\n * @returns {Promise<void>}\n */\nexport const theGlobalProperty = (globalPropertyName) =>\n    new Promise(resolve => (function loop() {\n        if (!window[globalPropertyName]) {\n            setTimeout(loop, 20);\n            return;\n        }\n        resolve();\n    })());\n\n/**\n * Initializes the calendar.\n * @param {Number}  cmid         Course-module id\n * @param {String}  eventsource  URL for JSON feed (events.php)\n * @param {Object}  capabilities {addevent: Boolean}\n * @param {String}  lang         Current UI language code\n * @param {Object}  config       Extra config (e.g. {textcolor:'#fff'})\n */\nexport async function init(cmid, eventsource, capabilities, lang, config) {\n    await theGlobalProperty('EventCalendar');\n\n    // Set textcolor.\n    let textcolor = '#ffffff';\n    if (Object.prototype.hasOwnProperty.call(config, 'textcolor')) {\n        textcolor = config.textcolor;\n    }\n\n    // Define toolbarbuttons.\n    let toolbarbuttons = 'prev,next today';\n    if (capabilities.addevent) {\n        toolbarbuttons = 'prev,next today addButton';\n    }\n\n    // String variables\n    await prefetchStrings('mod_bookit', ['addbooking', 'edit_event']);\n    await prefetchStrings('core', ['today', 'month', 'week']);\n    await prefetchStrings('calendar', ['day', 'upcomingevents']);\n    const strRequestBooking = await getString('addbooking', 'mod_bookit');\n    const strToday = await getString('today');\n    const strMonth = await getString('month');\n    const strWeek = await getString('week');\n    const strDay = await getString('day', 'calendar');\n    const strList = await getString('upcomingevents', 'calendar');\n\n    // Define viewtype\n    let viewType = 'timeGridWeek';\n    if (window.screen.width <= 1000) {\n        viewType = 'listWeek';\n    }\n    // Weekday visibility from admin settings (injected by PHP)\n    const allowedWeekdays = (window.M && M.cfg && Array.isArray(M.cfg.bookit_allowedweekdays))\n        ? M.cfg.bookit_allowedweekdays.map(x => Number(x))\n        : [1, 2, 3, 4, 5];\n\n    const hiddenDays = [0, 1, 2, 3, 4, 5, 6].filter(d => !allowedWeekdays.includes(d));\n\n    // Runtime filter parameters – mutable via bookitCalendarUpdate()\n    let extraFilterParams = {}; // {room:123, status:2, faculty:'ENG', …}\n\n    const calendar = new window.EventCalendar(document.getElementById('ec'), {\n        /* Appearance / behaviour */\n        locale: lang,\n        view: viewType,\n        firstDay: 1,\n        weekends: allowedWeekdays.includes(0) || allowedWeekdays.includes(6),\n        scrollTime: '09:00:00',\n        slotMinTime: '07:00:00',\n        dayMaxEvents: true,\n        nowIndicator: true,\n        hiddenDays: hiddenDays,\n        selectable: false,\n        eventTextColor: textcolor,\n        eventBackgroundColor: '#035AA3',\n        eventStartEditable: false,\n        eventDurationEditable: false,\n        buttonText: function(text) {\n            text.today = strToday;\n            text.dayGridMonth = strMonth;\n            text.timeGridWeek = strWeek;\n            text.timeGridDay = strDay;\n            text.listWeek = strList;\n            return text;\n        },\n\n        eventsSet: function(events) {\n            // Comment console.log('[BookIT] eventsSet: received', events.length, 'events');\n            if (events.length) {\n                /* Comment\n                console.log('[BookIT] sample event', {\n                    id: events[0].id,\n                    title: events[0].title,\n                    start: events[0].startStr || events[0].start,\n                    end: events[0].endStr || events[0].end,\n                    room: events[0].extendedProps?.room,\n                    department: events[0].extendedProps?.department,\n                    bookingstatus: events[0].extendedProps?.bookingstatus\n                });\n                */\n            }\n        },\n\n        /* Custom toolbar button (“Add booking”) */\n        customButtons: {\n            addButton: {\n                text: strRequestBooking,\n                click: function() {\n                    const modalForm = new ModalForm({\n                        formClass: 'mod_bookit\\\\form\\\\edit_event_form',\n                        args: {\n                            cmid: cmid\n                        },\n                        modalConfig: {title: getString('edit_event', 'mod_bookit')},\n                    });\n                    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n                        calendar.refetchEvents();\n                    });\n                    // XXX TODO: Merge 28.01 Was not part of vadyms_branch, caused issues. Was commented out.\n                    modalForm.addEventListener(modalForm.events.LOADED, initPossibleStarttimesRefresh);\n                    modalForm.show();\n                }\n            }\n        },\n\n        /* Date click (create new event) */\n        dateClick: function(info) {\n            const weekday = info.date.getUTCDay(); // 0=Sun … 6=Sat\n            if (!allowedWeekdays.includes(weekday)) {\n                return;\n            }\n\n            let d = new Date();\n            let dateoff = new Date(d.setMinutes(d.getMinutes() - d.getTimezoneOffset()));\n            let startdate = info.dateStr;\n\n            if (capabilities.addevent && startdate > dateoff.toISOString()) {\n                const modalForm = new ModalForm({\n                    formClass: 'mod_bookit\\\\form\\\\edit_event_form',\n                    args: {\n                        cmid: cmid,\n                        startdate: startdate,\n                    },\n                    modalConfig: {title: getString('edit_event', 'mod_bookit')},\n                });\n                modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n                    calendar.refetchEvents();\n                });\n                modalForm.addEventListener(modalForm.events.LOADED, initPossibleStarttimesRefresh);\n                modalForm.show();\n            }\n        },\n\n        /* Event click (edit) */\n        eventClick: function(info) {\n            let id = info.event.id;\n            if (info.event.extendedProps.reserved) {\n                return;\n            }\n\n            const modalForm = new ModalForm({\n                formClass: \"mod_bookit\\\\form\\\\edit_event_form\",\n                args: {\n                    cmid: cmid,\n                    id: id\n                },\n                modalConfig: {title: getString('edit_event', 'mod_bookit')},\n            });\n            modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n                calendar.refetchEvents();\n            });\n            // XXX TODO: Merge 28.01: This was not part of my branch, might cause issues. Commented out for debugging.\n            modalForm.addEventListener(modalForm.events.LOADED, initPossibleStarttimesRefresh);\n            modalForm.show();\n        },\n\n        // Toolbar configuration\n        headerToolbar: {\n            start: toolbarbuttons,\n            center: 'title',\n            end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'\n        },\n\n        resources: [],\n\n        // Feed with logged extra params\n        eventSources: [{\n            url: eventsource,\n            extraParams: () => {\n                // Console.log('[BookIT] extraParams sent →', extraFilterParams);\n                return extraFilterParams;\n            }\n        }],\n\n        views: {\n            timeGridWeek: {pointer: true},\n            resourceTimeGridWeek: {pointer: true},\n            resourceTimelineWeek: {\n                pointer: true,\n                slotMinTime: '09:00',\n                slotMaxTime: '21:00',\n                slotWidth: 80,\n                resources: []\n            }\n        }\n    });\n\n    window.bookitCalendar = calendar;\n\n    /* Expose update for the filter form (called from view.php) */\n    window.bookitCalendarUpdate = function(paramObj = {}) {\n        extraFilterParams = paramObj;\n        window.currentFilterParams = extraFilterParams;\n        calendar.refetchEvents();\n    };\n}\n"],"names":["cmid","eventsource","capabilities","lang","config","theGlobalProperty","textcolor","Object","prototype","hasOwnProperty","call","toolbarbuttons","addevent","strRequestBooking","strToday","strMonth","strWeek","strDay","strList","viewType","window","screen","width","allowedWeekdays","M","cfg","Array","isArray","bookit_allowedweekdays","map","x","Number","hiddenDays","filter","d","includes","extraFilterParams","calendar","EventCalendar","document","getElementById","locale","view","firstDay","weekends","scrollTime","slotMinTime","dayMaxEvents","nowIndicator","selectable","eventTextColor","eventBackgroundColor","eventStartEditable","eventDurationEditable","buttonText","text","today","dayGridMonth","timeGridWeek","timeGridDay","listWeek","eventsSet","events","length","customButtons","addButton","click","modalForm","ModalForm","formClass","args","modalConfig","title","addEventListener","FORM_SUBMITTED","refetchEvents","LOADED","initPossibleStarttimesRefresh","show","dateClick","info","weekday","date","getUTCDay","Date","dateoff","setMinutes","getMinutes","getTimezoneOffset","startdate","dateStr","toISOString","eventClick","id","event","extendedProps","reserved","headerToolbar","start","center","end","resources","eventSources","url","extraParams","views","pointer","resourceTimeGridWeek","resourceTimelineWeek","slotMaxTime","slotWidth","bookitCalendar","bookitCalendarUpdate","paramObj","currentFilterParams","globalPropertyName","Promise","resolve","loop","setTimeout"],"mappings":"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"}