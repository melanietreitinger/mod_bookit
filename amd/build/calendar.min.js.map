{"version":3,"file":"calendar.min.js","sources":["../src/calendar.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Manage the calendar\n *\n * @module     mod_bookit/calendar\n * @copyright  2024 Melanie Treitinger, Justus Dieckmann RUB\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getString} from 'core/str';\nimport ModalForm from 'core_form/modalform';\nimport {prefetchStrings} from 'core/prefetch';\nimport {initPossibleStarttimesRefresh} from \"mod_bookit/possible_slots_refresh\";\n\n/**\n * Wait until a global property exists (EventCalendar is loaded asynchronously).\n *\n * @param {String} globalPropertyName\n * @returns {Promise<void>}\n */\nconst theGlobalProperty = (globalPropertyName) =>\n    new Promise(resolve => (function loop() {\n        if (!window[globalPropertyName]) {\n            setTimeout(loop, 20);\n            return;\n        }\n        resolve();\n    })());\n\n/**\n * Initializes the calendar.\n * @param {Number}  cmid         Course-module id\n * @param {String}  eventsource  URL for JSON feed (events.php)\n * @param {Object}  capabilities {addevent: Boolean}\n * @param {String}  lang         Current UI language code\n * @param {Object}  config       Extra config (e.g. {textcolor:'#fff'})\n */\nexport async function init(cmid, eventsource, capabilities, lang, config) {\n    await theGlobalProperty('EventCalendar');\n\n    // Set textcolor.\n    let textcolor = '#ffffff';\n    if (Object.prototype.hasOwnProperty.call(config, 'textcolor')) {\n        textcolor = config.textcolor;\n    }\n\n    // Define toolbarbuttons.\n    let toolbarbuttons = 'prev,next today';\n    if (capabilities.addevent) {\n        toolbarbuttons = 'prev,next today addButton';\n    }\n\n    // String variables\n    await prefetchStrings('mod_bookit', ['addbooking', 'edit_event']);\n    await prefetchStrings('core', ['today', 'month', 'week']);\n    await prefetchStrings('calendar', ['day', 'upcomingevents']);\n    const str_request_booking = await getString('addbooking', 'mod_bookit');\n    const str_today = await getString('today');\n    const str_month = await getString('month');\n    const str_week = await getString('week');\n    const str_day = await getString('day', 'calendar');\n    const str_list = await getString('upcomingevents', 'calendar');\n\n    // Define viewtype\n    let viewType = 'timeGridWeek';\n    if (window.screen.width <= 1000) {\n        viewType = 'listWeek';\n    }\n    //Weekday visibility from admin settings (injected by PHP)\n    const allowedWeekdays = (window.M && M.cfg && Array.isArray(M.cfg.bookit_allowedweekdays))\n        ? M.cfg.bookit_allowedweekdays.map(x => Number(x))\n        : [1, 2, 3, 4, 5];\n\n    const hiddenDays = [0, 1, 2, 3, 4, 5, 6].filter(d => !allowedWeekdays.includes(d));\n\n    // Runtime filter parameters – mutable via bookitCalendarUpdate()\n    let extraFilterParams = {}; // {room:123, status:2, faculty:'ENG', …}\n\n    const calendar = new window.EventCalendar(document.getElementById('ec'), {\n        /* Appearance / behaviour */\n        locale: lang,\n        view: viewType,\n        firstDay: 1,\n        weekends: allowedWeekdays.includes(0) || allowedWeekdays.includes(6),\n        scrollTime: '09:00:00',\n        slotMinTime: '07:00:00',\n        dayMaxEvents: true,\n        nowIndicator: true,\n        hiddenDays: hiddenDays,\n        selectable: false,\n        eventTextColor: textcolor,\n        eventBackgroundColor: '#035AA3',\n        eventStartEditable: false,\n        eventDurationEditable: false,\n        buttonText: function(text) {\n            text.today = str_today;\n            text.dayGridMonth = str_month;\n            text.timeGridWeek = str_week;\n            text.timeGridDay = str_day;\n            text.listWeek = str_list;\n            return text;\n        },\n\n        /* Loading + delivery logs */\n        loading: function(isLoading) {\n            console.log('[BookIT] loading =', isLoading);\n        },\n        eventsSet: function(events) {\n            // Comment console.log('[BookIT] eventsSet: received', events.length, 'events');\n            if (events.length) {\n                /* Comment\n                console.log('[BookIT] sample event', {\n                    id: events[0].id,\n                    title: events[0].title,\n                    start: events[0].startStr || events[0].start,\n                    end: events[0].endStr || events[0].end,\n                    room: events[0].extendedProps?.room,\n                    department: events[0].extendedProps?.department,\n                    bookingstatus: events[0].extendedProps?.bookingstatus\n                });\n                */\n            }\n        },\n\n        /* Custom toolbar button (“Add booking”) */\n        customButtons: {\n            addButton: {\n                text: str_request_booking,\n                click: function() {\n                    const modalForm = new ModalForm({\n                        formClass: 'mod_bookit\\\\form\\\\edit_event_form',\n                        args: {cmid: cmid},\n                        modalConfig: {title: getString('edit_event', 'mod_bookit')},\n                    });\n                    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n                        calendar.refetchEvents();\n                    });\n                    modalForm.show();\n                }\n            }\n        },\n\n        /* Date click (create new event) */\n        dateClick: function(info) {\n            const weekday = info.date.getUTCDay(); // 0=Sun … 6=Sat\n            if (!allowedWeekdays.includes(weekday)) {\n                return;\n            }\n\n            let d = new Date();\n            let dateoff = new Date(d.setMinutes(d.getMinutes() - d.getTimezoneOffset()));\n            let startdate = info.dateStr;\n\n            if (capabilities.addevent && startdate > dateoff.toISOString()) {\n                const modalForm = new ModalForm({\n                    formClass: 'mod_bookit\\\\form\\\\edit_event_form',\n                    args: {cmid: cmid, startdate: startdate},\n                    modalConfig: {title: getString('edit_event', 'mod_bookit')},\n                });\n                modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n                    calendar.refetchEvents();\n                });\n                modalForm.addEventListener(modalForm.events.LOADED, initPossibleStarttimesRefresh);\n                modalForm.show();\n            }\n        },\n\n        /* Event click (edit) */\n        eventClick: function(info) {\n            let id = info.event.id;\n            if (info.event.extendedProps.reserved) {\n                return;\n            }\n\n            const modalForm = new ModalForm({\n                formClass: \"mod_bookit\\\\form\\\\edit_event_form\",\n                args: { cmid: cmid, id: id },\n                modalConfig: { title: getString('edit_event', 'mod_bookit') },\n            });\n            modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,() => {\n                calendar.refetchEvents();\n            });\n            modalForm.show();\n        },\n\n        // Toolbar configuration\n        headerToolbar: {\n            start: toolbarbuttons,\n            center: 'title',\n            end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'\n        },\n\n        resources: [],\n\n        // Feed with logged extra params\n        eventSources: [{\n            url: eventsource,\n            extraParams: () => {\n                console.log('[BookIT] extraParams sent →', extraFilterParams);\n                return extraFilterParams;\n            }\n        }],\n\n        views: {\n            timeGridWeek: {pointer: true},\n            resourceTimeGridWeek: {pointer: true},\n            resourceTimelineWeek: {\n                pointer: true,\n                slotMinTime: '09:00',\n                slotMaxTime: '21:00',\n                slotWidth: 80,\n                resources: []\n            }\n        }\n    });\n\n    window.bookitCalendar = calendar;\n\n    /* Expose update for the filter form (called from view.php) */\n    window.bookitCalendarUpdate = function(paramObj = {}) {\n        extraFilterParams = paramObj;\n        window.currentFilterParams = extraFilterParams;\n        calendar.refetchEvents();\n    };\n}\n"],"names":["cmid","eventsource","capabilities","lang","config","globalPropertyName","Promise","resolve","loop","window","setTimeout","textcolor","Object","prototype","hasOwnProperty","call","toolbarbuttons","addevent","str_request_booking","str_today","str_month","str_week","str_day","str_list","viewType","screen","width","allowedWeekdays","M","cfg","Array","isArray","bookit_allowedweekdays","map","x","Number","hiddenDays","filter","d","includes","extraFilterParams","calendar","EventCalendar","document","getElementById","locale","view","firstDay","weekends","scrollTime","slotMinTime","dayMaxEvents","nowIndicator","selectable","eventTextColor","eventBackgroundColor","eventStartEditable","eventDurationEditable","buttonText","text","today","dayGridMonth","timeGridWeek","timeGridDay","listWeek","loading","isLoading","console","log","eventsSet","events","length","customButtons","addButton","click","modalForm","ModalForm","formClass","args","modalConfig","title","addEventListener","FORM_SUBMITTED","refetchEvents","show","dateClick","info","weekday","date","getUTCDay","Date","dateoff","setMinutes","getMinutes","getTimezoneOffset","startdate","dateStr","toISOString","LOADED","initPossibleStarttimesRefresh","eventClick","id","event","extendedProps","reserved","headerToolbar","start","center","end","resources","eventSources","url","extraParams","views","pointer","resourceTimeGridWeek","resourceTimelineWeek","slotMaxTime","slotWidth","bookitCalendar","bookitCalendarUpdate","paramObj","currentFilterParams"],"mappings":"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"}