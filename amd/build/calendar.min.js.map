{"version":3,"file":"calendar.min.js","sources":["../src/calendar.js"],"sourcesContent":["import {getString} from 'core/str';\r\nimport ModalForm from 'core_form/modalform';\r\nimport {prefetchStrings} from 'core/prefetch';\r\n\r\n/**\r\n * Wait until a global property exists (EventCalendar is loaded asynchronously).\r\n *\r\n * @param {String} globalPropertyName\r\n * @returns {Promise<void>}\r\n */\r\nconst theGlobalProperty = (globalPropertyName) =>\r\n    new Promise(resolve => (function loop() {\r\n        if (!window[globalPropertyName]) {\r\n            setTimeout(loop, 20);\r\n            return;\r\n        }\r\n        resolve();\r\n    })());\r\n\r\n/**\r\n * Initializes the calendar.\r\n * @param {Number}  cmid         Course-module id\r\n * @param {String}  eventsource  URL for JSON feed (events.php)\r\n * @param {Object}  capabilities {addevent: Boolean}\r\n * @param {String}  lang         Current UI language code\r\n * @param {Object}  config       Extra config (e.g. {textcolor:'#fff'})\r\n */\r\nexport async function init(cmid, eventsource, capabilities, lang, config) {\r\n    await theGlobalProperty('EventCalendar');\r\n\r\n    // Set textcolor.\r\n    let textcolor = '#ffffff';\r\n    if (Object.prototype.hasOwnProperty.call(config, 'textcolor')) {\r\n        textcolor = config.textcolor;\r\n    }\r\n\r\n    // Define toolbarbuttons.\r\n    let toolbarbuttons = 'prev,next today';\r\n    if (capabilities.addevent) {\r\n        toolbarbuttons = 'prev,next today addButton';\r\n    }\r\n\r\n    // String variables\r\n    await prefetchStrings('mod_bookit', ['addbooking', 'edit_event']);\r\n    await prefetchStrings('core', ['today', 'month', 'week']);\r\n    await prefetchStrings('calendar', ['day', 'upcomingevents']);\r\n    const str_request_booking = await getString('addbooking', 'mod_bookit');\r\n    const str_today = await getString('today');\r\n    const str_month = await getString('month');\r\n    const str_week = await getString('week');\r\n    const str_day = await getString('day', 'calendar');\r\n    const str_list = await getString('upcomingevents', 'calendar');\r\n\r\n    // Define viewtype\r\n    let viewType = 'timeGridWeek';\r\n    if (window.screen.width <= 1000) {\r\n        viewType = 'listWeek';\r\n    }\r\n    //Weekday visibility from admin settings (injected by PHP)\r\n    const allowedWeekdays = (window.M && M.cfg && Array.isArray(M.cfg.bookit_allowedweekdays))\r\n        ? M.cfg.bookit_allowedweekdays.map(x => Number(x))\r\n        : [1, 2, 3, 4, 5];\r\n\r\n    const hiddenDays = [0, 1, 2, 3, 4, 5, 6].filter(d => !allowedWeekdays.includes(d));\r\n\r\n    // Runtime filter parameters – mutable via bookitCalendarUpdate()\r\n    let extraFilterParams = {}; // {room:123, status:2, faculty:'ENG', …}\r\n\r\n    const calendar = new window.EventCalendar(document.getElementById('ec'), {\r\n        /* Appearance / behaviour */\r\n        locale: lang,\r\n        view: viewType,\r\n        firstDay: 1,\r\n        weekends: allowedWeekdays.includes(0) || allowedWeekdays.includes(6),\r\n        scrollTime: '09:00:00',\r\n        slotMinTime: '07:00:00',\r\n        dayMaxEvents: true,\r\n        nowIndicator: true,\r\n        hiddenDays: hiddenDays,\r\n        selectable: false,\r\n        eventTextColor: textcolor,\r\n        eventBackgroundColor: '#035AA3',\r\n        eventStartEditable: false,\r\n        eventDurationEditable: false,\r\n        buttonText: function(text) {\r\n            text.today = str_today;\r\n            text.dayGridMonth = str_month;\r\n            text.timeGridWeek = str_week;\r\n            text.timeGridDay = str_day;\r\n            text.listWeek = str_list;\r\n            return text;\r\n        },\r\n\r\n        /* Loading + delivery logs */\r\n        loading: function(isLoading) {\r\n            console.log('[BookIT] loading =', isLoading);\r\n        },\r\n        eventsSet: function(events) {\r\n            // Comment console.log('[BookIT] eventsSet: received', events.length, 'events');\r\n            if (events.length) {\r\n                /* Comment\r\n                console.log('[BookIT] sample event', {\r\n                    id: events[0].id,\r\n                    title: events[0].title,\r\n                    start: events[0].startStr || events[0].start,\r\n                    end: events[0].endStr || events[0].end,\r\n                    room: events[0].extendedProps?.room,\r\n                    department: events[0].extendedProps?.department,\r\n                    bookingstatus: events[0].extendedProps?.bookingstatus\r\n                });\r\n                */\r\n            }\r\n        },\r\n\r\n        /* Custom toolbar button (“Add booking”) */\r\n        customButtons: {\r\n            addButton: {\r\n                text: str_request_booking,\r\n                click: function() {\r\n                    const modalForm = new ModalForm({\r\n                        formClass: 'mod_bookit\\\\form\\\\edit_event_form',\r\n                        args: {cmid: cmid},\r\n                        modalConfig: {title: getString('edit_event', 'mod_bookit')},\r\n                    });\r\n                    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\r\n                        calendar.refetchEvents();\r\n                    });\r\n                    modalForm.show();\r\n                }\r\n            }\r\n        },\r\n\r\n        /* Date click (create new event) */\r\n        dateClick: function(info) {\r\n            const weekday = info.date.getUTCDay(); // 0=Sun … 6=Sat\r\n            if (!allowedWeekdays.includes(weekday)) {\r\n                return;\r\n            }\r\n\r\n            let d = new Date();\r\n            let dateoff = new Date(d.setMinutes(d.getMinutes() - d.getTimezoneOffset()));\r\n            let startdate = info.dateStr;\r\n\r\n            if (capabilities.addevent && startdate > dateoff.toISOString()) {\r\n                const modalForm = new ModalForm({\r\n                    formClass: 'mod_bookit\\\\form\\\\edit_event_form',\r\n                    args: {cmid: cmid, startdate: startdate},\r\n                    modalConfig: {title: getString('edit_event', 'mod_bookit')},\r\n                });\r\n                modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\r\n                    calendar.refetchEvents();\r\n                });\r\n                modalForm.show();\r\n            }\r\n        },\r\n\r\n        /* Event click (edit) */\r\n        eventClick: function(info) {\r\n            let id = info.event.id;\r\n            if (info.event.extendedProps.reserved) {\r\n                return; \r\n            }\r\n\r\n            const modalForm = new ModalForm({\r\n                formClass: \"mod_bookit\\\\form\\\\edit_event_form\",\r\n                args: { cmid: cmid, id: id },\r\n                modalConfig: { title: getString('edit_event', 'mod_bookit') },\r\n            });\r\n            modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,() => {\r\n                calendar.refetchEvents();\r\n            });\r\n            modalForm.show();\r\n        },\r\n\r\n        // Toolbar configuration\r\n        headerToolbar: {\r\n            start: toolbarbuttons,\r\n            center: 'title',\r\n            end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'\r\n        },\r\n\r\n        resources: [],\r\n\r\n        // Feed with logged extra params\r\n        eventSources: [{\r\n            url: eventsource,\r\n            extraParams: () => {\r\n                console.log('[BookIT] extraParams sent →', extraFilterParams);\r\n                return extraFilterParams;\r\n            }\r\n        }],\r\n\r\n        views: {\r\n            timeGridWeek: {pointer: true},\r\n            resourceTimeGridWeek: {pointer: true},\r\n            resourceTimelineWeek: {\r\n                pointer: true,\r\n                slotMinTime: '09:00',\r\n                slotMaxTime: '21:00',\r\n                slotWidth: 80,\r\n                resources: []\r\n            }\r\n        }\r\n    });\r\n\r\n    window.bookitCalendar = calendar;\r\n\r\n    /* Expose update for the filter form (called from view.php) */\r\n    window.bookitCalendarUpdate = function(paramObj = {}) {\r\n        extraFilterParams = paramObj;\r\n        window.currentFilterParams = extraFilterParams;\r\n        calendar.refetchEvents();\r\n    };\r\n}\r\n"],"names":["cmid","eventsource","capabilities","lang","config","globalPropertyName","Promise","resolve","loop","window","setTimeout","textcolor","Object","prototype","hasOwnProperty","call","toolbarbuttons","addevent","str_request_booking","str_today","str_month","str_week","str_day","str_list","viewType","screen","width","allowedWeekdays","M","cfg","Array","isArray","bookit_allowedweekdays","map","x","Number","hiddenDays","filter","d","includes","extraFilterParams","calendar","EventCalendar","document","getElementById","locale","view","firstDay","weekends","scrollTime","slotMinTime","dayMaxEvents","nowIndicator","selectable","eventTextColor","eventBackgroundColor","eventStartEditable","eventDurationEditable","buttonText","text","today","dayGridMonth","timeGridWeek","timeGridDay","listWeek","loading","isLoading","console","log","eventsSet","events","length","customButtons","addButton","click","modalForm","ModalForm","formClass","args","modalConfig","title","addEventListener","FORM_SUBMITTED","refetchEvents","show","dateClick","info","weekday","date","getUTCDay","Date","dateoff","setMinutes","getMinutes","getTimezoneOffset","startdate","dateStr","toISOString","eventClick","id","event","extendedProps","reserved","headerToolbar","start","center","end","resources","eventSources","url","extraParams","views","pointer","resourceTimeGridWeek","resourceTimelineWeek","slotMaxTime","slotWidth","bookitCalendar","bookitCalendarUpdate","paramObj","currentFilterParams"],"mappings":"qOA2B2BA,KAAMC,YAAaC,aAAcC,KAAMC,cAjBvCC,mBAkBC,gBAjBxB,IAAIC,SAAQC,SAAY,SAASC,OACxBC,OAAOJ,oBAIZE,UAHIG,WAAWF,KAAM,IAFD,MADDH,IAAAA,uBAqBnBM,UAAY,UACZC,OAAOC,UAAUC,eAAeC,KAAKX,OAAQ,eAC7CO,UAAYP,OAAOO,eAInBK,eAAiB,kBACjBd,aAAae,WACbD,eAAiB,mCAIf,6BAAgB,aAAc,CAAC,aAAc,qBAC7C,6BAAgB,OAAQ,CAAC,QAAS,QAAS,eAC3C,6BAAgB,WAAY,CAAC,MAAO,yBACpCE,0BAA4B,kBAAU,aAAc,cACpDC,gBAAkB,kBAAU,SAC5BC,gBAAkB,kBAAU,SAC5BC,eAAiB,kBAAU,QAC3BC,cAAgB,kBAAU,MAAO,YACjCC,eAAiB,kBAAU,iBAAkB,gBAG/CC,SAAW,eACXf,OAAOgB,OAAOC,OAAS,MACvBF,SAAW,kBAGTG,gBAAmBlB,OAAOmB,GAAKA,EAAEC,KAAOC,MAAMC,QAAQH,EAAEC,IAAIG,wBAC5DJ,EAAEC,IAAIG,uBAAuBC,KAAIC,GAAKC,OAAOD,KAC7C,CAAC,EAAG,EAAG,EAAG,EAAG,GAEbE,WAAa,CAAC,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAGC,QAAOC,IAAMX,gBAAgBY,SAASD,SAG3EE,kBAAoB,SAElBC,SAAW,IAAIhC,OAAOiC,cAAcC,SAASC,eAAe,MAAO,CAErEC,OAAQ1C,KACR2C,KAAMtB,SACNuB,SAAU,EACVC,SAAUrB,gBAAgBY,SAAS,IAAMZ,gBAAgBY,SAAS,GAClEU,WAAY,WACZC,YAAa,WACbC,cAAc,EACdC,cAAc,EACdhB,WAAYA,WACZiB,YAAY,EACZC,eAAgB3C,UAChB4C,qBAAsB,UACtBC,oBAAoB,EACpBC,uBAAuB,EACvBC,WAAY,SAASC,aACjBA,KAAKC,MAAQzC,UACbwC,KAAKE,aAAezC,UACpBuC,KAAKG,aAAezC,SACpBsC,KAAKI,YAAczC,QACnBqC,KAAKK,SAAWzC,SACToC,MAIXM,QAAS,SAASC,WACdC,QAAQC,IAAI,qBAAsBF,YAEtCG,UAAW,SAASC,QAEZA,OAAOC,QAgBfC,cAAe,CACXC,UAAW,CACPd,KAAMzC,oBACNwD,MAAO,iBACGC,UAAY,IAAIC,mBAAU,CAC5BC,UAAW,oCACXC,KAAM,CAAC9E,KAAMA,MACb+E,YAAa,CAACC,OAAO,kBAAU,aAAc,iBAEjDL,UAAUM,iBAAiBN,UAAUL,OAAOY,gBAAgB,KACxDzC,SAAS0C,mBAEbR,UAAUS,UAMtBC,UAAW,SAASC,YACVC,QAAUD,KAAKE,KAAKC,gBACrB9D,gBAAgBY,SAASgD,oBAI1BjD,EAAI,IAAIoD,KACRC,QAAU,IAAID,KAAKpD,EAAEsD,WAAWtD,EAAEuD,aAAevD,EAAEwD,sBACnDC,UAAYT,KAAKU,WAEjB9F,aAAae,UAAY8E,UAAYJ,QAAQM,cAAe,OACtDtB,UAAY,IAAIC,mBAAU,CAC5BC,UAAW,oCACXC,KAAM,CAAC9E,KAAMA,KAAM+F,UAAWA,WAC9BhB,YAAa,CAACC,OAAO,kBAAU,aAAc,iBAEjDL,UAAUM,iBAAiBN,UAAUL,OAAOY,gBAAgB,KACxDzC,SAAS0C,mBAEbR,UAAUS,SAKlBc,WAAY,SAASZ,UACba,GAAKb,KAAKc,MAAMD,MAChBb,KAAKc,MAAMC,cAAcC,sBAIvB3B,UAAY,IAAIC,mBAAU,CAC5BC,UAAW,oCACXC,KAAM,CAAE9E,KAAMA,KAAMmG,GAAIA,IACxBpB,YAAa,CAAEC,OAAO,kBAAU,aAAc,iBAElDL,UAAUM,iBAAiBN,UAAUL,OAAOY,gBAAe,KACvDzC,SAAS0C,mBAEbR,UAAUS,QAIdmB,cAAe,CACXC,MAAOxF,eACPyF,OAAQ,QACRC,IAAK,kDAGTC,UAAW,GAGXC,aAAc,CAAC,CACXC,IAAK5G,YACL6G,YAAa,KACT3C,QAAQC,IAAI,8BAA+B5B,mBACpCA,qBAIfuE,MAAO,CACHjD,aAAc,CAACkD,SAAS,GACxBC,qBAAsB,CAACD,SAAS,GAChCE,qBAAsB,CAClBF,SAAS,EACT9D,YAAa,QACbiE,YAAa,QACbC,UAAW,GACXT,UAAW,OAKvBlG,OAAO4G,eAAiB5E,SAGxBhC,OAAO6G,qBAAuB,eAASC,gEAAW,GAC9C/E,kBAAoB+E,SACpB9G,OAAO+G,oBAAsBhF,kBAC7BC,SAAS0C"}