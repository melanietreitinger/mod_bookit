{"version":3,"file":"possible_slots_refresh.min.js","sources":["../src/possible_slots_refresh.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Fresh possible slots in the booking form.\n *\n * @module     mod_bookit/possible_slots_refresh\n * @copyright  2025 Justus Dieckmann RUB\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Ajax from 'core/ajax';\nimport {getString} from 'core/str';\nimport {prefetchStrings} from 'core/prefetch';\n\n/**\n * Initializes the calendar.\n */\nexport function initPossibleStarttimesRefresh() {\n    const formEl = document.querySelector('.modal-body form');\n    if (!formEl) {\n        setTimeout(initPossibleStarttimesRefresh, 50);\n        return;\n    }\n\n    void prefetchStrings('mod_bookit', ['no_slot_available', 'no_weekplan_defined']);\n\n    const roomEl = formEl.querySelector('select[name=\"roomid\"]');\n    const durationEl = formEl.querySelector('select[name=\"duration\"]');\n    const dateDayEl = formEl.querySelector('select[name=\"startdate[day]\"]');\n    const dateMonthEl = formEl.querySelector('select[name=\"startdate[month]\"]');\n    const dateYearEl = formEl.querySelector('select[name=\"startdate[year]\"]');\n\n    const timeEl = formEl.querySelector('select[name=\"starttime\"]');\n\n    const starttimeEl = document.querySelector('.fitem:has(select[name=\"starttime\"])');\n    const starttimeExplanationEl = document.querySelector('.fitem:has(.form-control-static[data-name=\"starttime_explanation\"])');\n    const starttimeExplanationTextEl = starttimeExplanationEl.querySelector(\n        '.form-control-static[data-name=\"starttime_explanation\"]'\n    );\n\n    const refreshStarttimes = async() => {\n        const year = parseInt(dateYearEl.value);\n        const month = parseInt(dateMonthEl.value);\n        const day = parseInt(dateDayEl.value);\n\n        const {slots: starttimes, status} = await Ajax.call([{\n            methodname: 'mod_bookit_get_possible_starttimes',\n            args: {\n                year: year,\n                month: month,\n                day: day,\n                duration: durationEl.value,\n                roomid: roomEl.value,\n            }\n        }])[0];\n\n        const currentSelected = new Date(timeEl.value * 1000);\n\n        while (timeEl.options.length) {\n            timeEl.options.remove(0);\n        }\n\n        starttimeEl.hidden = status !== null;\n        starttimeExplanationEl.hidden = status === null;\n\n        if (status !== null) {\n            starttimeExplanationTextEl.innerHTML =\n                await getString(status === 1 ? 'no_weekplan_defined' : 'no_slot_available',\n                    'mod_bookit');\n        }\n\n        for (let slot of starttimes) {\n            const opt = document.createElement(\"option\");\n            opt.value = slot.timestamp;\n            opt.innerText = slot.string;\n            const date = new Date(slot.timestamp * 1000);\n            if (date.getHours() * 60 + date.getMinutes() === currentSelected.getHours() * 60 + currentSelected.getMinutes()) {\n                opt.selected = true;\n            }\n            timeEl.options.add(opt);\n        }\n    };\n\n    for (let el of [roomEl, durationEl, dateDayEl, dateMonthEl, dateYearEl]) {\n        el.addEventListener('change', refreshStarttimes);\n    }\n    void refreshStarttimes();\n}\n"],"names":["initPossibleStarttimesRefresh","formEl","document","querySelector","setTimeout","roomEl","durationEl","dateDayEl","dateMonthEl","dateYearEl","timeEl","starttimeEl","starttimeExplanationEl","starttimeExplanationTextEl","refreshStarttimes","async","year","parseInt","value","month","day","slots","starttimes","status","Ajax","call","methodname","args","duration","roomid","currentSelected","Date","options","length","remove","hidden","innerHTML","slot","opt","createElement","timestamp","innerText","string","date","getHours","getMinutes","selected","add","el","addEventListener"],"mappings":";;;;;;;;SA8BgBA,sCACNC,OAASC,SAASC,cAAc,wBACjCF,mBACDG,WAAWJ,8BAA+B,KAIzC,6BAAgB,aAAc,CAAC,oBAAqB,8BAEnDK,OAASJ,OAAOE,cAAc,yBAC9BG,WAAaL,OAAOE,cAAc,2BAClCI,UAAYN,OAAOE,cAAc,iCACjCK,YAAcP,OAAOE,cAAc,mCACnCM,WAAaR,OAAOE,cAAc,kCAElCO,OAAST,OAAOE,cAAc,4BAE9BQ,YAAcT,SAASC,cAAc,wCACrCS,uBAAyBV,SAASC,cAAc,uEAChDU,2BAA6BD,uBAAuBT,cACtD,2DAGEW,kBAAoBC,gBAChBC,KAAOC,SAASR,WAAWS,OAC3BC,MAAQF,SAAST,YAAYU,OAC7BE,IAAMH,SAASV,UAAUW,QAExBG,MAAOC,WAARC,OAAoBA,cAAgBC,KAAKC,KAAK,CAAC,CACjDC,WAAY,qCACZC,KAAM,CACFX,KAAMA,KACNG,MAAOA,MACPC,IAAKA,IACLQ,SAAUtB,WAAWY,MACrBW,OAAQxB,OAAOa,UAEnB,GAEEY,gBAAkB,IAAIC,KAAoB,IAAfrB,OAAOQ,YAEjCR,OAAOsB,QAAQC,QAClBvB,OAAOsB,QAAQE,OAAO,GAG1BvB,YAAYwB,OAAoB,OAAXZ,OACrBX,uBAAuBuB,OAAoB,OAAXZ,OAEjB,OAAXA,SACAV,2BAA2BuB,gBACjB,kBAAqB,IAAXb,OAAe,sBAAwB,oBACnD,mBAGP,IAAIc,QAAQf,WAAY,OACnBgB,IAAMpC,SAASqC,cAAc,UACnCD,IAAIpB,MAAQmB,KAAKG,UACjBF,IAAIG,UAAYJ,KAAKK,aACfC,KAAO,IAAIZ,KAAsB,IAAjBM,KAAKG,WACL,GAAlBG,KAAKC,WAAkBD,KAAKE,eAA8C,GAA7Bf,gBAAgBc,WAAkBd,gBAAgBe,eAC/FP,IAAIQ,UAAW,GAEnBpC,OAAOsB,QAAQe,IAAIT,WAItB,IAAIU,KAAM,CAAC3C,OAAQC,WAAYC,UAAWC,YAAaC,YACxDuC,GAAGC,iBAAiB,SAAUnC,mBAE7BA"}