{"version":3,"file":"export_modal.min.js","sources":["../src/export_modal.js"],"sourcesContent":["define(['jquery', 'core/str'], function($, str) {\n\n    return {\n        init: function(cmId) {\n\n            // Preload needed strings\n            const stringKeys = [\n                {key: 'noevents', component: 'mod_bookit'},\n                {key: 'chooseevent', component: 'mod_bookit'}\n            ];\n\n            str.get_strings(stringKeys).done(function(strings) {\n                const noEventsStr = strings[0];\n                /**\n                Function to filter the export list\n                 */\n                function filterExportList() {\n                    const val = ($('#bookit-modal-search').val() || '').toLowerCase().trim();\n                    $('#bookit-export-list label').each(function() {\n                        const $row = $(this);\n                        const show = $row.text().toLowerCase().includes(val);\n                        $row.toggleClass('d-flex', show)\n                             .toggleClass('d-none', !show);\n                    });\n                }\n\n                $('#bookit-export').on('click', function() {\n                    const qs = {id: cmId, start: '1970-01-01T00:00', end: '2100-01-01T00:00'};\n                    if (window.currentFilterParams) {\n                        Object.assign(qs, window.currentFilterParams);\n                    }\n\n                    const list = $('#bookit-export-list');\n                    list.html(\n                        '<div class=\"text-center p-3\">' +\n                            '<i class=\"fa fa-spinner fa-spin\"></i>' +\n                        '</div>'\n                    );\n                    $('#bookit-export-modal').modal('show');\n\n                    $.getJSON(M.cfg.wwwroot + '/mod/bookit/events.php', qs, function(data) {\n                        list.empty();\n\n                        // Remove reserved events entirely (Fix for Issue #102)\n                        data = data.filter(e => !(e.extendedProps && (e.extendedProps.reserved === true\n                            || e.extendedProps.reserved === 1)));\n\n                        if (!data.length) {\n                            list.append('<div class=\"text-muted\">' + noEventsStr + '</div>');\n                            return;\n                        }\n\n                        const statusMap = {'0': 'New', '1': 'In progress', '2': 'Accepted',\n                            '3': 'Cancelled', '4': 'Rejected'};\n\n                        data.forEach(function(e) {\n                            const roomTxt = (e.location || e.room || '').trim();\n                            const faculty = (e.department || '').trim();\n                            const statusTxt = statusMap[e.bookingstatus] || '';\n                            const startStr = (e.start || '');\n                            const dateTxt = startStr ? startStr.substr(0, 16).replace('T', ' ') : '';\n                            const metaLine = roomTxt ? (roomTxt + ' ' + dateTxt) : dateTxt;\n\n                            const checkbox = '<input class=\"form-check-input mt-1\" type=\"checkbox\" value=\"' + e.id + '\">';\n\n                            const row = $(\n                                '<label class=\"list-group-item d-flex gap-2 align-items-start\" ' +\n                                ' data-room=\"' + roomTxt.toLowerCase() + '\" ' +\n                                ' data-faculty=\"' + faculty.toLowerCase() + '\" ' +\n                                ' data-status=\"' + statusTxt.toLowerCase() + '\">' +\n                                    checkbox +\n                                    '<span>' + (e.title || '') + ' <small class=\"text-muted\">(' + metaLine + ')</small></span>' +\n                                '</label>'\n                            );\n                            list.append(row);\n                        });\n\n                        filterExportList();\n                    });\n                });\n\n                $('#bookit-modal-search').on('input', filterExportList);\n\n                $('#bookit-check-all').on('click', function() {\n                    $('#bookit-export-list label:visible input[type=checkbox]:enabled').prop('checked', true);\n                });\n                $('#bookit-uncheck-all').on('click', function() {\n                    $('#bookit-export-list label:visible input[type=checkbox]:enabled').prop('checked', false);\n                });\n\n                $('#bookit-export-confirm').on('click', function() {\n                    const ids = $('#bookit-export-list input[type=checkbox]:enabled:checked')\n                        .map(function() {\n                            return this.value;\n                        }).get();\n                    if (!ids.length) {\n                        return;\n                    }\n\n                    const qs = new URLSearchParams({id: cmId});\n                    if (window.currentFilterParams) {\n                        Object.entries(window.currentFilterParams).forEach(([k, v]) => qs.append(k, v));\n                    }\n                    ids.forEach(id => qs.append('ids[]', id));\n\n                    window.location = M.cfg.wwwroot + '/mod/bookit/export_events.php?' + qs.toString();\n                    $('#bookit-export-modal').modal('hide');\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","str","init","cmId","get_strings","key","component","done","strings","noEventsStr","filterExportList","val","toLowerCase","trim","each","$row","this","show","text","includes","toggleClass","on","qs","id","start","end","window","currentFilterParams","Object","assign","list","html","modal","getJSON","M","cfg","wwwroot","data","empty","filter","e","extendedProps","reserved","length","append","statusMap","forEach","roomTxt","location","room","faculty","department","statusTxt","bookingstatus","startStr","dateTxt","substr","replace","metaLine","checkbox","row","title","prop","ids","map","value","get","URLSearchParams","entries","_ref","k","v","toString"],"mappings":"AAAAA,iCAAO,CAAC,SAAU,aAAa,SAASC,EAAGC,WAEhC,CACHC,KAAM,SAASC,MAQXF,IAAIG,YALe,CACf,CAACC,IAAK,WAAYC,UAAW,cAC7B,CAACD,IAAK,cAAeC,UAAW,gBAGRC,MAAK,SAASC,eAChCC,YAAcD,QAAQ,YAInBE,yBACCC,KAAOX,EAAE,wBAAwBW,OAAS,IAAIC,cAAcC,OAClEb,EAAE,6BAA6Bc,MAAK,iBAC1BC,KAAOf,EAAEgB,MACTC,KAAOF,KAAKG,OAAON,cAAcO,SAASR,KAChDI,KAAKK,YAAY,SAAUH,MACrBG,YAAY,UAAWH,SAIrCjB,EAAE,kBAAkBqB,GAAG,SAAS,iBACtBC,GAAK,CAACC,GAAIpB,KAAMqB,MAAO,mBAAoBC,IAAK,oBAClDC,OAAOC,qBACPC,OAAOC,OAAOP,GAAII,OAAOC,2BAGvBG,KAAO9B,EAAE,uBACf8B,KAAKC,KACD,4EAIJ/B,EAAE,wBAAwBgC,MAAM,QAEhChC,EAAEiC,QAAQC,EAAEC,IAAIC,QAAU,yBAA0Bd,IAAI,SAASe,SAC7DP,KAAKQ,UAGLD,KAAOA,KAAKE,QAAOC,KAAOA,EAAEC,iBAA+C,IAA7BD,EAAEC,cAAcC,UAC1B,IAA7BF,EAAEC,cAAcC,cAEbC,mBACNb,KAAKc,OAAO,2BAA6BnC,YAAc,gBAIrDoC,UAAY,GAAM,QAAY,gBAAoB,aAC/C,cAAkB,YAE3BR,KAAKS,SAAQ,SAASN,SACZO,SAAWP,EAAEQ,UAAYR,EAAES,MAAQ,IAAIpC,OACvCqC,SAAWV,EAAEW,YAAc,IAAItC,OAC/BuC,UAAYP,UAAUL,EAAEa,gBAAkB,GAC1CC,SAAYd,EAAEhB,OAAS,GACvB+B,QAAUD,SAAWA,SAASE,OAAO,EAAG,IAAIC,QAAQ,IAAK,KAAO,GAChEC,SAAWX,QAAWA,QAAU,IAAMQ,QAAWA,QAEjDI,SAAW,+DAAiEnB,EAAEjB,GAAK,KAEnFqC,IAAM5D,EACR,6EACiB+C,QAAQnC,cADzB,oBAEoBsC,QAAQtC,cAF5B,mBAGmBwC,UAAUxC,cAAgB,KACzC+C,SACA,UAAYnB,EAAEqB,OAAS,IAAM,+BAAiCH,SALlE,4BAQJ5B,KAAKc,OAAOgB,QAGhBlD,yBAIRV,EAAE,wBAAwBqB,GAAG,QAASX,kBAEtCV,EAAE,qBAAqBqB,GAAG,SAAS,WAC/BrB,EAAE,kEAAkE8D,KAAK,WAAW,MAExF9D,EAAE,uBAAuBqB,GAAG,SAAS,WACjCrB,EAAE,kEAAkE8D,KAAK,WAAW,MAGxF9D,EAAE,0BAA0BqB,GAAG,SAAS,iBAC9B0C,IAAM/D,EAAE,4DACTgE,KAAI,kBACMhD,KAAKiD,SACbC,UACFH,IAAIpB,oBAIHrB,GAAK,IAAI6C,gBAAgB,CAAC5C,GAAIpB,OAChCuB,OAAOC,qBACPC,OAAOwC,QAAQ1C,OAAOC,qBAAqBmB,SAAQuB,WAAEC,EAAGC,eAAOjD,GAAGsB,OAAO0B,EAAGC,MAEhFR,IAAIjB,SAAQvB,IAAMD,GAAGsB,OAAO,QAASrB,MAErCG,OAAOsB,SAAWd,EAAEC,IAAIC,QAAU,iCAAmCd,GAAGkD,WACxExE,EAAE,wBAAwBgC,MAAM"}