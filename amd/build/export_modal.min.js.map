{"version":3,"file":"export_modal.min.js","sources":["../src/export_modal.js"],"sourcesContent":["define(['jquery', 'core/str'], function($, str) {\r\n    return {\r\n        init: function(cmId) {\r\n\r\n            const stringKeys = [\r\n                {key: 'noevents', component: 'mod_bookit'},\r\n                {key: 'chooseevent', component: 'mod_bookit'}\r\n            ];\r\n\r\n            str.get_strings(stringKeys).done(function(strings) {\r\n                const noEventsStr = strings[0];\r\n\r\n                /**\r\n                 * Convert a date-like value to a local (browser timezone) `YYYY-MM-DD` string.\r\n                 *\r\n                 * This normalises the date to local time before formatting, avoiding the common\r\n                 * off-by-one issue caused by `toISOString()` using UTC.\r\n                 *\r\n                 * @param {Date|string|number} dateObj A `Date` instance or any value accepted by `new Date(...)`.\r\n                 * @returns {string} Date formatted as `YYYY-MM-DD` in local time.\r\n                 */\r\n                function toLocalDateValue(dateObj) {\r\n                    // Date -> 'YYYY-MM-DD' in local time.\r\n                    const d = new Date(dateObj);\r\n                    const offMin = d.getTimezoneOffset();\r\n                    const local = new Date(d.getTime() - offMin * 60000);\r\n                    return local.toISOString().slice(0, 10);\r\n                }\r\n\r\n                /**\r\n                 * Get the currently visible calendar date range from the global Bookit calendar.\r\n                 *\r\n                 * If the calendar instance is not available, returns a wide fallback range so\r\n                 * the export modal can still function (and the backend can apply its own limits).\r\n                 *\r\n                 * Notes:\r\n                 * - `activeStart` is inclusive.\r\n                 * - `activeEnd` is typically exclusive, so we convert it to an inclusive end date\r\n                 *   by subtracting 1ms.\r\n                 *\r\n                 * @returns {{startDate: string, endDate: string}} Object with `YYYY-MM-DD` start and end dates.\r\n                 */\r\n                function getCalendarDateRangeOrFallback() {\r\n                    if (window.bookitCalendar && window.bookitCalendar.view) {\r\n                        const view = window.bookitCalendar.view;\r\n\r\n                        const startDate = toLocalDateValue(view.activeStart);\r\n\r\n                        const endInclusive = new Date(view.activeEnd.getTime() - 1);\r\n                        const endDate = toLocalDateValue(endInclusive);\r\n\r\n                        return {startDate, endDate};\r\n                    }\r\n                    return {startDate: '1970-01-01', endDate: '2100-01-01'};\r\n                }\r\n\r\n                /**\r\n                 * Filter the export list entries by the export modal search input.\r\n                 *\r\n                 * This performs a case-insensitive substring match against each label's text and\r\n                 * toggles visibility using Bootstrap utility classes (`d-flex` / `d-none`).\r\n                 *\r\n                 * Expects:\r\n                 * - `#bookit-modal-search` input to exist.\r\n                 * - Each export entry to be represented by a `label` element within\r\n                 *   `#bookit-export-list`.\r\n                 *\r\n                 * @returns {void}\r\n                 */\r\n                function filterExportList() {\r\n                    const val = ($('#bookit-modal-search').val() || '').toLowerCase().trim();\r\n                    $('#bookit-export-list label').each(function() {\r\n                        const $row = $(this);\r\n                        const show = $row.text().toLowerCase().includes(val);\r\n                        $row.toggleClass('d-flex', show).toggleClass('d-none', !show);\r\n                    });\r\n                }\r\n\r\n\r\n                /**\r\n                 * Fetch events for the export modal and render them as a checkbox list.\r\n                 *\r\n                 * Uses the modal date range if set, otherwise falls back to the current calendar view range.\r\n                 * Merges `window.currentFilterParams` except `start`/`end` (modal range wins).\r\n                 *\r\n                 * @returns {void}\r\n                 */\r\n                function fetchExportList() {\r\n                    const qs = {id: cmId};\r\n\r\n                    const startDate = ($('#bookit-export-start').val() || '').trim();\r\n                    const endDate = ($('#bookit-export-end').val() || '').trim();\r\n                    const fallback = getCalendarDateRangeOrFallback();\r\n\r\n                    const s = startDate || fallback.startDate;\r\n                    const e = endDate || fallback.endDate;\r\n\r\n                    qs.start = s + 'T00:00';\r\n                    qs.end   = e + 'T23:59';\r\n\r\n                    if (window.currentFilterParams) {\r\n                        Object.keys(window.currentFilterParams).forEach(function(k) {\r\n                            if (k === 'start' || k === 'end') {\r\n                                return; // Never allow filters to override modal range.\r\n                            }\r\n                            qs[k] = window.currentFilterParams[k];\r\n                        });\r\n                    }\r\n\r\n\r\n                    const list = $('#bookit-export-list');\r\n                    list.html('<div class=\"text-center p-3\"><i class=\"fa fa-spinner fa-spin\"></i></div>');\r\n\r\n                    $.getJSON(M.cfg.wwwroot + '/mod/bookit/events.php', qs, function(data) {\r\n                        list.empty();\r\n\r\n                        data = (data || []).filter(e => !(e.extendedProps &&\r\n                            (e.extendedProps.reserved === true || e.extendedProps.reserved === 1)));\r\n\r\n                        if (!data.length) {\r\n                            list.append('<div class=\"text-muted\">' + noEventsStr + '</div>');\r\n                            return;\r\n                        }\r\n\r\n                        const statusMap = {'0': 'New', '1': 'In progress', '2': 'Accepted', '3': 'Cancelled', '4': 'Rejected'};\r\n\r\n                        data.forEach(function(e) {\r\n                            const roomTxt = (e.location || e.room || e.roomname || '').trim();\r\n                            const faculty = (e.department || e.faculty || '').trim();\r\n                            const statusTxt = statusMap[String(e.bookingstatus ?? '')] || '';\r\n                            const startStr = (e.start || '');\r\n                            const dateTxt = startStr ? String(startStr).substr(0, 16).replace('T', ' ') : '';\r\n                            const metaLine = roomTxt ? (roomTxt + ' ' + dateTxt) : dateTxt;\r\n\r\n                            const checkbox = '<input class=\"form-check-input mt-1\" type=\"checkbox\" value=\"' + e.id + '\">';\r\n\r\n                            const row = $(\r\n                                '<label class=\"list-group-item d-flex gap-2 align-items-start\" ' +\r\n                                ' data-room=\"' + roomTxt.toLowerCase() + '\" ' +\r\n                                ' data-faculty=\"' + faculty.toLowerCase() + '\" ' +\r\n                                ' data-status=\"' + statusTxt.toLowerCase() + '\">' +\r\n                                    checkbox +\r\n                                    '<span>' + (e.title?.html || e.title || '') +\r\n                                    ' <small class=\"text-muted\">(' + metaLine + ')</small></span>' +\r\n                                '</label>'\r\n                            );\r\n                            list.append(row);\r\n                        });\r\n\r\n                        filterExportList();\r\n                    }).fail(function(xhr) {\r\n                        list.empty();\r\n                        list.append('<div class=\"text-danger\">events.php failed: ' + (xhr.responseText || xhr.status) + '</div>');\r\n                    });\r\n                }\r\n                /**\r\n                 * Open the export modal and load the initial list for the current calendar range.\r\n                 */\r\n                $(document).on('click', '#bookit-export', function() {\r\n                    const r = getCalendarDateRangeOrFallback();\r\n                    $('#bookit-export-start').val(r.startDate);\r\n                    $('#bookit-export-end').val(r.endDate);\r\n\r\n                    $('#bookit-export-modal').modal('show');\r\n                    fetchExportList();\r\n                });\r\n\r\n                /**\r\n                 * Refresh export list when the modal date range changes (only while modal is open).\r\n                 */\r\n                $(document).on('change input', '#bookit-export-start, #bookit-export-end', function() {\r\n                    if ($('#bookit-export-modal').hasClass('show')) {\r\n                        fetchExportList();\r\n                    }\r\n                });\r\n\r\n                /**\r\n                 * Reset modal date range to the current calendar view and refresh list.\r\n                 */\r\n                $(document).on('click', '#bookit-export-reset-range', function() {\r\n                    const r = getCalendarDateRangeOrFallback();\r\n                    $('#bookit-export-start').val(r.startDate);\r\n                    $('#bookit-export-end').val(r.endDate);\r\n                    fetchExportList();\r\n                });\r\n\r\n                // Apply live text filter to the export list.\r\n                $(document).on('input', '#bookit-modal-search', filterExportList);\r\n\r\n                // Select all visible, enabled event checkboxes.\r\n                $(document).on('click', '#bookit-check-all', function() {\r\n                    $('#bookit-export-list label:visible input[type=checkbox]:enabled').prop('checked', true);\r\n                });\r\n\r\n                // Deselect all visible, enabled event checkboxes.\r\n                $(document).on('click', '#bookit-uncheck-all', function() {\r\n                    $('#bookit-export-list label:visible input[type=checkbox]:enabled').prop('checked', false);\r\n                });\r\n\r\n                /**\r\n                 * Start export for selected event ids and close the modal.\r\n                 *\r\n                 * Builds a query containing `ids[]` plus the current filter params and navigates to export endpoint.\r\n                 */\r\n                $(document).on('click', '#bookit-export-confirm', function() {\r\n                    const ids = $('#bookit-export-list input[type=checkbox]:enabled:checked')\r\n                        .map(function() { \r\n                            return this.value; \r\n                        }).get();\r\n\r\n                    if (!ids.length) {\r\n                        return;\r\n                    }\r\n\r\n                    const qs = new URLSearchParams({id: cmId});\r\n                    if (window.currentFilterParams) {\r\n                        Object.entries(window.currentFilterParams).forEach(([k, v]) => qs.append(k, v));\r\n                    }\r\n                    ids.forEach(id => qs.append('ids[]', id));\r\n\r\n                    window.location = M.cfg.wwwroot + '/mod/bookit/export_events.php?' + qs.toString();\r\n                    $('#bookit-export-modal').modal('hide');\r\n                });\r\n            });\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","str","init","cmId","get_strings","key","component","done","strings","noEventsStr","toLocalDateValue","dateObj","d","Date","offMin","getTimezoneOffset","getTime","toISOString","slice","getCalendarDateRangeOrFallback","window","bookitCalendar","view","startDate","activeStart","endDate","activeEnd","filterExportList","val","toLowerCase","trim","each","$row","this","show","text","includes","toggleClass","fetchExportList","qs","id","fallback","s","e","start","end","currentFilterParams","Object","keys","forEach","k","list","html","getJSON","M","cfg","wwwroot","data","empty","filter","extendedProps","reserved","length","append","statusMap","roomTxt","location","room","roomname","faculty","department","statusTxt","String","bookingstatus","startStr","dateTxt","substr","replace","metaLine","checkbox","row","title","fail","xhr","responseText","status","document","on","r","modal","hasClass","prop","ids","map","value","get","URLSearchParams","entries","_ref","v","toString"],"mappings":"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"}