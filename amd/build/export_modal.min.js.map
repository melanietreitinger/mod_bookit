{"version":3,"file":"export_modal.min.js","sources":["../src/export_modal.js"],"sourcesContent":["// File: mod/bookit/amd/src/export_modal.js\r\ndefine(['jquery', 'core/str'], function($, str) {\r\n\r\n    return {\r\n        init: function(cmId) {\r\n\r\n            // preload needed strings\r\n            const stringKeys = [\r\n                {key: 'noevents', component: 'mod_bookit'},\r\n                {key: 'chooseevent', component: 'mod_bookit'}\r\n            ];\r\n\r\n            str.get_strings(stringKeys).done(function(strings) {\r\n                const noEventsStr = strings[0];\r\n                const chooseEventStr = strings[1];\r\n\r\n                function filterExportList() {\r\n                    const val = ($('#bookit-modal-search').val() || '').toLowerCase().trim();\r\n                    $('#bookit-export-list label').each(function () {\r\n                        const $row = $(this);\r\n                        const show = $row.text().toLowerCase().includes(val);\r\n                        $row.toggleClass('d-flex', show)\r\n                             .toggleClass('d-none', !show);\r\n                    });\r\n                }\r\n\r\n                $('#bookit-export').on('click', function () {\r\n                    const qs = { id: cmId, start:'1970-01-01T00:00', end:'2100-01-01T00:00' };\r\n                    if (window.currentFilterParams) Object.assign(qs, window.currentFilterParams);\r\n\r\n                    const list = $('#bookit-export-list');\r\n                    list.html('<div class=\"text-center p-3\"><i class=\"fa fa-spinner fa-spin\"></i></div>');\r\n                    $('#bookit-export-modal').modal('show');\r\n\r\n                    $.getJSON(M.cfg.wwwroot + '/mod/bookit/events.php', qs, function(data){\r\n                        list.empty();\r\n\r\n                        // remove reserved events entirely (Fix for Issue #102)\r\n                        data = data.filter(e => !(e.extendedProps && (e.extendedProps.reserved === true || e.extendedProps.reserved === 1)));\r\n\r\n                        if (!data.length) {\r\n                            list.append('<div class=\"text-muted\">' + noEventsStr + '</div>');\r\n                            return;\r\n                        }\r\n\r\n                        const statusMap = {0:'New',1:'In progress',2:'Accepted',3:'Cancelled',4:'Rejected'};\r\n\r\n                        data.forEach(function (e) {\r\n                            const roomTxt = (e.location || e.room || '').trim();\r\n                            const faculty = (e.department || '').trim();\r\n                            const statusTxt = statusMap[e.bookingstatus] || '';\r\n                            const startStr = (e.start || '');\r\n                            const dateTxt = startStr ? startStr.substr(0,16).replace('T',' ') : '';\r\n                            const metaLine = roomTxt ? (roomTxt + ' ' + dateTxt) : dateTxt;\r\n\r\n                            const checkbox = '<input class=\"form-check-input mt-1\" type=\"checkbox\" value=\"'+ e.id +'\">';\r\n\r\n                            const row = $(\r\n                                '<label class=\"list-group-item d-flex gap-2 align-items-start\" ' +\r\n                                ' data-room=\"'+ roomTxt.toLowerCase() +'\" ' +\r\n                                ' data-faculty=\"'+ faculty.toLowerCase() +'\" ' +\r\n                                ' data-status=\"'+ statusTxt.toLowerCase() +'\">' +\r\n                                    checkbox +\r\n                                    '<span>'+ (e.title || '') +' <small class=\"text-muted\">(' + metaLine + ')</small></span>' +\r\n                                '</label>'\r\n                            );\r\n                            list.append(row);\r\n                        });\r\n\r\n                        filterExportList();\r\n                    });\r\n                });\r\n\r\n                $('#bookit-modal-search').on('input', filterExportList);\r\n\r\n                $('#bookit-check-all').on('click', function () {\r\n                    $('#bookit-export-list label:visible input[type=checkbox]:enabled').prop('checked', true);\r\n                });\r\n                $('#bookit-uncheck-all').on('click', function () {\r\n                    $('#bookit-export-list label:visible input[type=checkbox]:enabled').prop('checked', false);\r\n                });\r\n\r\n                $('#bookit-export-confirm').on('click', function () {\r\n                    const ids = $('#bookit-export-list input[type=checkbox]:enabled:checked')\r\n                        .map(function(){ return this.value; }).get();\r\n                    if (!ids.length) { alert(chooseEventStr); return; }\r\n\r\n                    const qs = new URLSearchParams({id: cmId});\r\n                    if (window.currentFilterParams) {\r\n                        Object.entries(window.currentFilterParams).forEach(([k,v]) => qs.append(k, v));\r\n                    }\r\n                    ids.forEach(id => qs.append('ids[]', id));\r\n\r\n                    window.location = M.cfg.wwwroot + '/mod/bookit/export_events.php?' + qs.toString();\r\n                    $('#bookit-export-modal').modal('hide');\r\n                });\r\n            });\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","str","init","cmId","get_strings","key","component","done","strings","noEventsStr","chooseEventStr","filterExportList","val","toLowerCase","trim","each","$row","this","show","text","includes","toggleClass","on","qs","id","start","end","window","currentFilterParams","Object","assign","list","html","modal","getJSON","M","cfg","wwwroot","data","empty","filter","e","extendedProps","reserved","length","append","statusMap","forEach","roomTxt","location","room","faculty","department","statusTxt","bookingstatus","startStr","dateTxt","substr","replace","metaLine","checkbox","row","title","prop","ids","map","value","get","alert","URLSearchParams","entries","_ref","k","v","toString"],"mappings":"AACAA,iCAAO,CAAC,SAAU,aAAa,SAASC,EAAGC,WAEhC,CACHC,KAAM,SAASC,MAQXF,IAAIG,YALe,CACf,CAACC,IAAK,WAAYC,UAAW,cAC7B,CAACD,IAAK,cAAeC,UAAW,gBAGRC,MAAK,SAASC,eAChCC,YAAcD,QAAQ,GACtBE,eAAiBF,QAAQ,YAEtBG,yBACCC,KAAOZ,EAAE,wBAAwBY,OAAS,IAAIC,cAAcC,OAClEd,EAAE,6BAA6Be,MAAK,iBAC1BC,KAAOhB,EAAEiB,MACTC,KAAOF,KAAKG,OAAON,cAAcO,SAASR,KAChDI,KAAKK,YAAY,SAAUH,MACrBG,YAAY,UAAWH,SAIrClB,EAAE,kBAAkBsB,GAAG,SAAS,iBACtBC,GAAK,CAAEC,GAAIrB,KAAMsB,MAAM,mBAAoBC,IAAI,oBACjDC,OAAOC,qBAAqBC,OAAOC,OAAOP,GAAII,OAAOC,2BAEnDG,KAAO/B,EAAE,uBACf+B,KAAKC,KAAK,4EACVhC,EAAE,wBAAwBiC,MAAM,QAEhCjC,EAAEkC,QAAQC,EAAEC,IAAIC,QAAU,yBAA0Bd,IAAI,SAASe,SAC7DP,KAAKQ,UAGLD,KAAOA,KAAKE,QAAOC,KAAOA,EAAEC,iBAA+C,IAA7BD,EAAEC,cAAcC,UAAkD,IAA7BF,EAAEC,cAAcC,cAEzFC,mBACNb,KAAKc,OAAO,2BAA6BpC,YAAc,gBAIrDqC,UAAY,GAAG,QAAQ,gBAAgB,aAAa,cAAc,YAExER,KAAKS,SAAQ,SAAUN,SACbO,SAAWP,EAAEQ,UAAYR,EAAES,MAAQ,IAAIpC,OACvCqC,SAAWV,EAAEW,YAAc,IAAItC,OAC/BuC,UAAYP,UAAUL,EAAEa,gBAAkB,GAC1CC,SAAYd,EAAEhB,OAAS,GACvB+B,QAAUD,SAAWA,SAASE,OAAO,EAAE,IAAIC,QAAQ,IAAI,KAAO,GAC9DC,SAAWX,QAAWA,QAAU,IAAMQ,QAAWA,QAEjDI,SAAW,+DAAgEnB,EAAEjB,GAAI,KAEjFqC,IAAM7D,EACR,6EACgBgD,QAAQnC,cADxB,oBAEmBsC,QAAQtC,cAF3B,mBAGkBwC,UAAUxC,cAAe,KACvC+C,SACA,UAAWnB,EAAEqB,OAAS,IAAK,+BAAiCH,SALhE,4BAQJ5B,KAAKc,OAAOgB,QAGhBlD,yBAIRX,EAAE,wBAAwBsB,GAAG,QAASX,kBAEtCX,EAAE,qBAAqBsB,GAAG,SAAS,WAC/BtB,EAAE,kEAAkE+D,KAAK,WAAW,MAExF/D,EAAE,uBAAuBsB,GAAG,SAAS,WACjCtB,EAAE,kEAAkE+D,KAAK,WAAW,MAGxF/D,EAAE,0BAA0BsB,GAAG,SAAS,iBAC9B0C,IAAMhE,EAAE,4DACTiE,KAAI,kBAAmBhD,KAAKiD,SAAUC,UACtCH,IAAIpB,mBAAUwB,MAAM1D,sBAEnBa,GAAK,IAAI8C,gBAAgB,CAAC7C,GAAIrB,OAChCwB,OAAOC,qBACPC,OAAOyC,QAAQ3C,OAAOC,qBAAqBmB,SAAQwB,WAAEC,EAAEC,eAAOlD,GAAGsB,OAAO2B,EAAGC,MAE/ET,IAAIjB,SAAQvB,IAAMD,GAAGsB,OAAO,QAASrB,MAErCG,OAAOsB,SAAWd,EAAEC,IAAIC,QAAU,iCAAmCd,GAAGmD,WACxE1E,EAAE,wBAAwBiC,MAAM"}