define("mod_bookit/masterchecklist/master_checklist",["exports","core/reactive","mod_bookit/masterchecklist/master_checklist_reactive","core_form/modalform","core/templates","core/toast","core/str","mod_bookit/helpers/checklist_helper"],(function(_exports,_reactive,_master_checklist_reactive,_modalform,_templates,Toast,_str,_checklist_helper){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_modalform=_interopRequireDefault(_modalform),_templates=_interopRequireDefault(_templates),Toast=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Toast),_checklist_helper=_interopRequireDefault(_checklist_helper);class _default extends _reactive.BaseComponent{static getEvents(){return{categoryRendered:"mod_bookit:master_checklist_category_rendered"}}static init(target,selectors){return new this({element:document.querySelector(target),reactive:_master_checklist_reactive.masterChecklistReactiveInstance,selectors:selectors||_master_checklist_reactive.SELECTORS})}create(){this.helper=new _checklist_helper.default}getWatchers(){return[{watch:"checklistcategories:created",handler:this._handleCategoryCreatedEvent},{watch:"checklistcategories:deleted",handler:this._handleCategoryDeletedEvent},{watch:"checklistcategories.name:updated",handler:this._handleCategoryNameUpdatedEvent},{watch:"checklistitems:created",handler:this._handleItemCreatedEvent},{watch:"checklistitems:deleted",handler:this._handleItemDeletedEvent},{watch:"checklistitems.title:updated",handler:this._replaceRenderedItem},{watch:"checklistitems.roomids:updated",handler:this._replaceRenderedItem},{watch:"checklistitems.roleids:updated",handler:this._replaceRenderedItem},{watch:"activeRoom:created",handler:this._handleFilterUpdate}]}stateReady(state){const name=state.masterchecklists.get(1).name;this.getElement(this.selectors.MASTER_CHECKLIST_TITLE).innerHTML=name,this.addEventListener(this.getElement(this.selectors.ADD_CHECKLIST_ITEM_BUTTON),"click",(e=>{e.preventDefault(),this._handleAddChecklistItemButtonClick(e)})),this.addEventListener(this.getElement(this.selectors.ADD_CHECKLIST_CATEGORY_BUTTON),"click",(e=>{e.preventDefault(),this._handleAddChecklistCategoryButtonClick(e)})),this.addEventListener(this.getElement(this.selectors.ROLE_SELECT),"change",(e=>{this.reactive.dispatch("roleChanged",{id:e.target.value})})),this.addEventListener(this.getElement(this.selectors.ROOM_SELECT),"change",(e=>{this.reactive.dispatch("roomChanged",{options:e.target.selectedOptions})})),this.addEventListener(this.getElement(this.selectors.EXPORT_BTN),"click",(e=>{e.preventDefault(),this._handleExportChecklistButtonClick(e)})),this.addEventListener(this.getElement(this.selectors.IMPORT_BTN),"click",(e=>{e.preventDefault(),this._handleImportChecklistButtonClick(e)}));document.querySelector(this.selectors.LOADING_SPINNER).classList.add("d-none");const mainElement=document.querySelector(this.selectors.MAIN_ELEMENT);mainElement.classList.remove("d-none"),mainElement.classList.add("d-flex")}_handleFilterUpdate(event){if("0"===event.element.id){const roomSelect=this.getElement(this.selectors.ROOM_SELECT);for(let option of roomSelect.options)"0"!==option.value?option.selected=!1:option.selected=!0}}async _handleAddChecklistItemButtonClick(){const modalForm=new _modalform.default({formClass:"mod_bookit\\local\\form\\masterchecklist\\edit_checklist_item_form",args:{masterid:1,itemid:null,categories:Array.from(this.reactive.state.checklistcategories.values())},modalConfig:{title:await(0,_str.getString)("checklistitem","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{this.reactive.dispatch("checklistitemCreated",response.detail)})),modalForm.show()}async _handleAddChecklistCategoryButtonClick(){const modalForm=new _modalform.default({formClass:"mod_bookit\\local\\form\\masterchecklist\\edit_checklist_category_form",args:{masterid:1},modalConfig:{title:await(0,_str.getString)("checklistcategory","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{this.reactive.stateManager.processUpdates(response.detail)})),modalForm.show()}async _handleExportChecklistButtonClick(){var _this$reactive$state$,_this$reactive$state$2;const masterid=(null===(_this$reactive$state$=this.reactive.state.masterchecklists)||void 0===_this$reactive$state$||null===(_this$reactive$state$2=_this$reactive$state$.get(1))||void 0===_this$reactive$state$2?void 0:_this$reactive$state$2.id)||1,modalForm=new _modalform.default({formClass:"mod_bookit\\local\\form\\masterchecklist\\export_checklist_form",args:{masterid:masterid},modalConfig:{title:await(0,_str.getString)("export","mod_bookit")},saveButtonText:await(0,_str.getString)("export","mod_bookit")});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(async response=>{response.detail.success&&response.detail.downloadurl?(window.open(response.detail.downloadurl,"_blank"),Toast.add(await(0,_str.getString)("export_success","mod_bookit"),{type:"success"})):Toast.add(response.detail.message||await(0,_str.getString)("export_error","mod_bookit"),{type:"error"})})),modalForm.show()}async _handleImportChecklistButtonClick(){var _this$reactive$state$3,_this$reactive$state$4;const masterid=(null===(_this$reactive$state$3=this.reactive.state.masterchecklists)||void 0===_this$reactive$state$3||null===(_this$reactive$state$4=_this$reactive$state$3.get(1))||void 0===_this$reactive$state$4?void 0:_this$reactive$state$4.id)||1,modalForm=new _modalform.default({formClass:"mod_bookit\\local\\form\\masterchecklist\\import_checklist_form",args:{masterid:masterid},modalConfig:{title:await(0,_str.getString)("import","mod_bookit")},saveButtonText:await(0,_str.getString)("import","mod_bookit")});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(async response=>{response.detail.success?(Toast.add(response.detail.message||await(0,_str.getString)("importsuccessful","mod_bookit"),{type:"success"}),response.detail.reload&&window.location.reload()):Toast.add(response.detail.message||await(0,_str.getString)("importfailed","mod_bookit"),{type:"error"})})),modalForm.show()}_handleCategoryCreatedEvent(event){if(this.reactive.state.checklistcategories&&this.reactive.state.checklistcategories.size>0){const noContentElement=this.getElement(this.selectors.NOCONTENT);noContentElement&&noContentElement.remove()}_templates.default.renderForPromise("mod_bookit/masterchecklist/bookit_checklist_category",{id:event.element.id,name:event.element.name,order:event.element.order,masterid:1,type:"category"}).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.appendNodeContents(this.getElement(this.selectors.TABLE),html,js)})).then((async()=>{if(await Toast.add(await(0,_str.getString)("checklistcategorysuccess","mod_bookit"),{type:"success"}),0!==this.reactive.state.activeRole.id||0!==this.reactive.state.activeRoom.id){const components=this.reactive.components,categoryComponent=this.helper.findComponents(components,{dataset:{bookitTbodyCategoryId:event.element.id.toString()},onlyFirst:!1}).find((comp=>"function"==typeof comp._handleFilterUpdate));categoryComponent&&categoryComponent._handleFilterUpdate(event)}})).catch((error=>{window.console.error("Error rendering checklist category:",error)}))}_handleItemCreatedEvent(event){const targetElement=this.getElement(`#bookit-master-checklist-tbody-category-${event.element.category}`),roomNames=[];event.element.roomnames&&event.element.roomnames.forEach((room=>{roomNames.push({roomid:room.roomid,roomname:room.roomname,eventcolor:room.eventcolor,textclass:room.textclass})}));const roleNames=[];event.element.rolenames&&event.element.rolenames.forEach((role=>{roleNames.push({roleid:role.roleid,rolename:role.rolename,extraclasses:role.extraclasses})})),_templates.default.renderForPromise("mod_bookit/masterchecklist/bookit_checklist_item",{id:event.element.id,title:event.element.title,order:event.element.order,categoryid:event.element.category,roomids:event.element.roomids,roomnames:roomNames,roleids:event.element.roleids,rolenames:roleNames,type:"item"}).then((_ref2=>{let{html:html,js:js}=_ref2;return _templates.default.appendNodeContents(targetElement,html,js)})).then((async()=>{await Toast.add(await(0,_str.getString)("checklistitemsuccess","mod_bookit"),{type:"success"});const components=this.reactive.components,categoryResults=this.helper.findComponents(components,{dataset:{bookitCategoryId:event.element.category},onlyFirst:!0});if(categoryResults.length>0){const categoryComponent=categoryResults[0];categoryComponent._handleFilterUpdate&&categoryComponent._handleFilterUpdate(event)}})).catch((error=>{window.console.error("Error rendering checklist item:",error)}))}_handleItemDeletedEvent(event){this.getElement(`#bookit-master-checklist-item-${event.element.id}`).remove(),Toast.add((0,_str.getString)("checklistitemdeleted","mod_bookit",{title:event.element.title}),{type:"success"})}_replaceRenderedItem(event){const fieldPart=event.action.split(".")[1].split(":")[0];if(fieldPart.endsWith("ids")){const stateItem=this.reactive.state.checklistitems.get(event.element.id),selector=`td[data-bookit-checklistitem-tabledata-${fieldPart}-id="${event.element.id}"]`,targetElement=this.getElement(selector);let templateName,templateData;if(fieldPart.startsWith("room"))templateName="mod_bookit/masterchecklist/bookit_checklist_item_rooms",templateData={id:event.element.id,roomnames:stateItem.roomnames};else{if(!fieldPart.startsWith("role"))return;templateName="mod_bookit/masterchecklist/bookit_checklist_item_roles",templateData={id:event.element.id,rolenames:stateItem.rolenames}}_templates.default.renderForPromise(templateName,templateData).then((_ref3=>{let{html:html,js:js}=_ref3;return _templates.default.replaceNode(targetElement,html,js)})).then((async()=>Toast.add(await(0,_str.getString)("checklistitemupdatesuccess","mod_bookit"),{type:"success"}))).catch((error=>{window.console.error("Error rendering checklist item field update:",error)}))}else{const elementSelector=`span[data-bookit-checklistitem-tabledata-${fieldPart}-id="${event.element.id}"]`,targetElement=this.getElement(elementSelector);targetElement?targetElement.innerHTML=event.element[fieldPart]:window.console.error("Target element not found for selector:",elementSelector)}}_handleCategoryDeletedEvent(event){this.getElement(`#bookit-master-checklist-tbody-category-${event.element.id}`).remove(),Toast.add((0,_str.getString)("checklistcategorydeleted","mod_bookit",{name:event.element.name}),{type:"success"})}_handleCategoryNameUpdatedEvent(event){const targetElement=this.getElement(`#bookit-master-checklist-category-row-${event.element.id}`);_templates.default.renderForPromise("mod_bookit/masterchecklist/bookit_checklist_category_row",{id:event.element.id,name:event.element.name,order:event.element.order,type:"category"}).then((_ref4=>{let{html:html,js:js}=_ref4;return _templates.default.replaceNode(targetElement,html,js)})).then((async()=>(await Toast.add(await(0,_str.getString)("checklistcategoryupdatesuccess","mod_bookit"),{type:"success"}),this.dispatchEvent(this.events.categoryRendered,{categoryId:event.element.id})))).catch((error=>{window.console.error("Error rendering checklist category:",error)}))}_handleRoleUpdate(event){document.querySelectorAll(this.selectors.ALL_CATEGORY_TABLE_ROWS).forEach((categoryElement=>{const items=[...this.reactive.state.checklistcategories.get(categoryElement.dataset.bookitCategoryId).items];var hasVisibleItems=!1;const activeRoom=this.reactive.state.activeRoom.id;items.forEach((itemId=>{const itemElement=document.querySelector(`tr[data-bookit-checklistitem-id="${itemId}"]`);0===activeRoom?parseInt(itemElement.dataset.bookitChecklistitemRole)===event.element.id||0===event.element.id?(itemElement.classList.remove("d-none"),hasVisibleItems||(hasVisibleItems=!0)):itemElement.classList.add("d-none"):activeRoom===parseInt(itemElement.dataset.bookitChecklistitemRoom)&&(parseInt(itemElement.dataset.bookitChecklistitemRole)===event.element.id||0===event.element.id)?(itemElement.classList.remove("d-none"),hasVisibleItems||(hasVisibleItems=!0)):itemElement.classList.add("d-none")})),hasVisibleItems?categoryElement.classList.remove("d-none"):categoryElement.classList.add("d-none")}))}}return _exports.default=_default,_exports.default}));

//# sourceMappingURL=master_checklist.min.js.map