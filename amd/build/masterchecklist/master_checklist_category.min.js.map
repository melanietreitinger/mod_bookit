{"version":3,"file":"master_checklist_category.min.js","sources":["../../src/masterchecklist/master_checklist_category.js"],"sourcesContent":["import {BaseComponent, DragDrop} from 'core/reactive';\r\nimport {masterChecklistReactiveInstance} from 'mod_bookit/masterchecklist/master_checklist_reactive';\r\nimport {SELECTORS} from 'mod_bookit/masterchecklist/master_checklist_reactive';\r\nimport ModalForm from 'core_form/modalform';\r\nimport {getString} from 'core/str';\r\nimport ChecklistHelper from 'mod_bookit/helpers/checklist_helper';\r\nimport Notification from 'core/notification';\r\n\r\nexport default class extends BaseComponent {\r\n\r\n    create(descriptor) {\r\n        this.helper = new ChecklistHelper();\r\n\r\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + descriptor.element.dataset.bookitCategoryId;\r\n\r\n        this.selectors[categoryEditBtnSelector] =\r\n            `#edit-checklistcategory-${descriptor.element.dataset.bookitCategoryId}`;\r\n\r\n        const categoryTbodySelector = 'CATEGORY_TBODY_' + descriptor.element.dataset.bookitCategoryId;\r\n        this.selectors[categoryTbodySelector] =\r\n            `#bookit-master-checklist-tbody-category-${descriptor.element.dataset.bookitCategoryId}`;\r\n    }\r\n\r\n    static init(target, selectors) {\r\n        return new this({\r\n            element: document.querySelector(target),\r\n            reactive: masterChecklistReactiveInstance,\r\n            selectors: selectors || SELECTORS,\r\n        });\r\n    }\r\n\r\n    getWatchers() {\r\n\r\n        return [\r\n            {watch: 'checklistcategories.name:updated', handler: this._refreshEditButtonListener},\r\n            {watch: 'activeRole:updated', handler: this._handleFilterUpdate},\r\n            {watch: 'activeRoom:created', handler: this._handleFilterUpdate},\r\n            {watch: 'checklistitems:created', handler: this._handleFilterUpdate},\r\n            {watch: 'checklistitems.roomids:updated', handler: this._handleFilterUpdate},\r\n            {watch: 'checklistitems.roleids:updated', handler: this._handleFilterUpdate},\r\n\r\n            // Item rooms and roles watchers\r\n        ];\r\n    }\r\n\r\n    stateReady() {\r\n\r\n        this.dragdrop = new DragDrop(this);\r\n\r\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + this.element.dataset.bookitCategoryId;\r\n\r\n        this.addEventListener(this.getElement(this.selectors[categoryEditBtnSelector]), 'click', (e) => {\r\n            e.preventDefault();\r\n            this._handleEditChecklistCategoryButtonClick(e);\r\n        });\r\n\r\n        document.addEventListener('mod_bookit:master_checklist_category_rendered', (e) => {\r\n\r\n            this._refreshEditButtonListener(e);\r\n        }, true);\r\n    }\r\n\r\n    destroy() {\r\n        if (this.dragdrop !== undefined) {\r\n            this.dragdrop.unregister();\r\n        }\r\n    }\r\n\r\n    validateDropData() {\r\n        return true;\r\n    }\r\n\r\n    async _handleEditChecklistCategoryButtonClick() {\r\n        const modalForm = new ModalForm({\r\n            formClass: 'mod_bookit\\\\local\\\\form\\\\masterchecklist\\\\edit_checklist_category_form',\r\n            moduleName: 'mod_bookit/modal_delete_save_cancel',\r\n            args: {\r\n                id: this.element.dataset.bookitCategoryId,\r\n                masterid: 1,\r\n                checklistitems: JSON.stringify(\r\n                    this.reactive.state.checklistcategories.get(this.element.dataset.bookitCategoryId).items\r\n                ),\r\n            },\r\n            modalConfig: {\r\n                title: await getString('checklistcategory', 'mod_bookit'),\r\n            },\r\n        });\r\n\r\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (response) => {\r\n            this.reactive.stateManager.processUpdates(response.detail);\r\n        });\r\n\r\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\r\n\r\n            const deleteButton = modalForm.modal.getRoot().find('button[data-action=\"delete\"]');\r\n\r\n            deleteButton.on('click', async(e) => {\r\n                e.preventDefault();\r\n                const confirmTitle = await getString('confirm', 'core');\r\n                const confirmMessage = await getString('areyousure', 'core');\r\n                const deleteText = await getString('delete', 'core');\r\n\r\n                Notification.deleteCancel(\r\n                    confirmTitle,\r\n                    confirmMessage,\r\n                    deleteText,\r\n                    () => {\r\n                        modalForm.getFormNode().querySelector('input[name=\"action\"]').value = 'delete';\r\n                        modalForm.submitFormAjax();\r\n                    }\r\n                );\r\n            });\r\n        });\r\n\r\n        modalForm.show();\r\n    }\r\n\r\n    _refreshEditButtonListener() {\r\n        this.removeAllEventListeners();\r\n\r\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + this.element.dataset.bookitCategoryId;\r\n\r\n        this.addEventListener(this.getElement(this.selectors[categoryEditBtnSelector]), 'click', (e) => {\r\n            e.preventDefault();\r\n            this._handleEditChecklistCategoryButtonClick(e);\r\n        });\r\n    }\r\n\r\n    drop(dropdata) {\r\n        switch (dropdata.type) {\r\n            case 'item':\r\n                this._handleItemDrop(dropdata);\r\n                break;\r\n            case 'category':\r\n                this._handleCategoryDrop(dropdata);\r\n                break;\r\n            default:\r\n                throw new Error(`Unknown drop type: ${dropdata.type}`);\r\n        }\r\n    }\r\n\r\n    showDropZone() {\r\n        const root = document.querySelector('html');\r\n        const primaryColor = getComputedStyle(root).getPropertyValue('--primary');\r\n\r\n        this.element.style.boxShadow = `0px -5px 0px 0px ${primaryColor} inset`;\r\n        this.element.style.transition = 'box-shadow 0.1s ease';\r\n    }\r\n\r\n    hideDropZone() {\r\n        this.element.style.boxShadow = '';\r\n        this.element.style.backgroundBlendMode = '';\r\n        this.element.style.transition = '';\r\n    }\r\n\r\n    _handleItemDrop(dropdata) {\r\n\r\n        const categoryObject = this.reactive.state.checklistcategories.get(this.element.dataset.bookitCategoryId);\r\n\r\n        const categoryObjectItems = [...categoryObject.items];\r\n\r\n        const lastItemId = categoryObjectItems[categoryObjectItems.length - 1];\r\n\r\n        dropdata.targetId = parseInt(lastItemId);\r\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitCategoryId);\r\n\r\n        this.reactive.dispatch('reOrderCategoryItems', dropdata);\r\n\r\n        const itemObject = this.reactive.state.checklistitems.get(dropdata.id);\r\n\r\n        const itemElement = document.getElementById(`bookit-master-checklist-item-${itemObject.id}`);\r\n\r\n        const itemHasChangedParent = dropdata.parentId !== dropdata.targetParentId;\r\n\r\n        if (itemHasChangedParent) {\r\n            itemElement.dataset.bookitChecklistitemCategoryid = dropdata.targetParentId;\r\n        }\r\n\r\n        this.element.append(itemElement);\r\n    }\r\n\r\n\r\n    _handleCategoryDrop(dropdata) {\r\n\r\n        dropdata.targetId = parseInt(this.element.dataset.bookitCategoryId);\r\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitCategoryMasterid);\r\n\r\n        this.reactive.dispatch('reOrderCategories', dropdata);\r\n\r\n        const categoryObject = this.reactive.state.checklistcategories.get(dropdata.id);\r\n\r\n        const categoryElement = document.getElementById(`bookit-master-checklist-tbody-category-${categoryObject.id}`);\r\n\r\n        const tableElement = document.querySelector(this.selectors.TABLE);\r\n\r\n        tableElement.insertBefore(categoryElement, this.element.nextElementSibling);\r\n\r\n    }\r\n\r\n     _handleFilterUpdate() {\r\n        const components = this.reactive.components;\r\n        const results = this.helper.findComponents(components, {\r\n            dataset: {bookitChecklistitemCategoryid: this.element.dataset.bookitCategoryId},\r\n            onlyFirst: false\r\n        });\r\n\r\n\r\n        if (!results || results.length === 0) {\r\n            const activeRooms = this.reactive.state.activeRoom;\r\n            const activeRoleId = this.reactive.state.activeRole.id;\r\n            const noRoomSelection = activeRooms.some(room => {\r\n                return room.id == 0;\r\n            });\r\n            if (activeRoleId == 0 && noRoomSelection) {\r\n                this.element.classList.remove('d-none');\r\n            }\r\n        } else {\r\n\r\n            var hasVisibleItems = false;\r\n            results.forEach((component) => {\r\n                const itemIsVisible = component.shouldBeVisible();\r\n                if (itemIsVisible) {\r\n                    hasVisibleItems = true;\r\n                }\r\n            });\r\n\r\n            if (!hasVisibleItems) {\r\n                this.element.classList.add('d-none');\r\n            } else {\r\n                this.element.classList.remove('d-none');\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n}"],"names":["BaseComponent","create","descriptor","helper","ChecklistHelper","categoryEditBtnSelector","element","dataset","bookitCategoryId","selectors","categoryTbodySelector","target","this","document","querySelector","reactive","masterChecklistReactiveInstance","SELECTORS","getWatchers","watch","handler","_refreshEditButtonListener","_handleFilterUpdate","stateReady","dragdrop","DragDrop","addEventListener","getElement","e","preventDefault","_handleEditChecklistCategoryButtonClick","destroy","undefined","unregister","validateDropData","modalForm","ModalForm","formClass","moduleName","args","id","masterid","checklistitems","JSON","stringify","state","checklistcategories","get","items","modalConfig","title","events","FORM_SUBMITTED","response","stateManager","processUpdates","detail","LOADED","modal","getRoot","find","on","async","confirmTitle","confirmMessage","deleteText","deleteCancel","getFormNode","value","submitFormAjax","show","removeAllEventListeners","drop","dropdata","type","_handleItemDrop","_handleCategoryDrop","Error","showDropZone","root","primaryColor","getComputedStyle","getPropertyValue","style","boxShadow","transition","hideDropZone","backgroundBlendMode","categoryObjectItems","lastItemId","length","targetId","parseInt","targetParentId","dispatch","itemObject","itemElement","getElementById","parentId","bookitChecklistitemCategoryid","append","bookitCategoryMasterid","categoryObject","categoryElement","TABLE","insertBefore","nextElementSibling","components","results","findComponents","onlyFirst","hasVisibleItems","forEach","component","shouldBeVisible","classList","remove","add","activeRooms","activeRoom","activeRoleId","activeRole","noRoomSelection","some","room"],"mappings":"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"}