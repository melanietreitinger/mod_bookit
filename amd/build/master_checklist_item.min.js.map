{"version":3,"file":"master_checklist_item.min.js","sources":["../src/master_checklist_item.js"],"sourcesContent":["import { BaseComponent, DragDrop } from 'core/reactive';\r\nimport { masterChecklistReactiveInstance } from 'mod_bookit/master_checklist_reactive';\r\nimport { SELECTORS } from 'mod_bookit/master_checklist_reactive';\r\nimport ModalForm from 'core_form/modalform';\r\nimport { getString } from 'core/str';\r\n\r\nexport default class extends BaseComponent {\r\n\r\n    create(descriptor) {\r\n\r\n        const itemEditBtnSelector = 'EDIT_CHECKLISTITEM_BTN_' + descriptor.element.dataset.bookitChecklistitemId;\r\n        this.selectors[itemEditBtnSelector] = `#edit-checklistitem-${descriptor.element.dataset.bookitChecklistitemId}`;\r\n    }\r\n\r\n    static init(target, selectors) {\r\n        return new this({\r\n            element: document.querySelector(target),\r\n            reactive: masterChecklistReactiveInstance,\r\n            selectors: selectors || SELECTORS,\r\n        });\r\n    }\r\n\r\n    getWatchers() {\r\n        return [];\r\n    }\r\n\r\n    stateReady(state) {\r\n\r\n        this.dragdrop = new DragDrop(this);\r\n\r\n        const itemEditBtnSelector = 'EDIT_CHECKLISTITEM_BTN_' + this.element.dataset.bookitChecklistitemId;\r\n\r\n        this.addEventListener(this.getElement(this.selectors[itemEditBtnSelector]), 'click', (e) => {\r\n            e.preventDefault();\r\n            this._handleEditChecklistItemButtonClick(e);\r\n        });\r\n\r\n    }\r\n\r\n    destroy() {\r\n        if (this.dragdrop !== undefined) {\r\n            this.dragdrop.unregister();\r\n        }\r\n    }\r\n\r\n    validateDropData(dropdata) {\r\n        return true;\r\n    }\r\n\r\n    drop(dropdata, event) {\r\n        switch (dropdata.type) {\r\n            case 'item':\r\n                this._handleItemDrop(dropdata, event);\r\n                break;\r\n            case 'category':\r\n                this._handleCategoryDrop(dropdata, event);\r\n                break;\r\n            default:\r\n                throw new Error(`Unknown drop type: ${dropdata.type}`);\r\n        }\r\n    }\r\n\r\n\r\n    showDropZone(dropdata, event) {\r\n\r\n        const root = document.querySelector('html');\r\n        const primaryColor = getComputedStyle(root).getPropertyValue('--primary');\r\n\r\n        switch (dropdata.type) {\r\n            case 'item':\r\n            this.element.style.boxShadow = `0px -5px 0px 0px ${primaryColor} inset`;\r\n            this.element.style.transition = 'box-shadow 0.1s ease';\r\n                break;\r\n            case 'category':\r\n                const itemParentId = parseInt(this.element.dataset.bookitChecklistitemCategoryid);\r\n                const categoryParentElement = document.getElementById(`bookit-master-checklist-tbody-category-${itemParentId}`);\r\n                var isActive = parseInt(categoryParentElement.dataset.bookitCategoryActive || 0);\r\n                if (!isActive) {\r\n                    categoryParentElement.dataset.bookitCategoryActive = 1;\r\n                }\r\n                const categoryLastChild = categoryParentElement.lastElementChild;\r\n                setTimeout(() => {\r\n                    categoryParentElement.dataset.bookitCategoryActive = 0;\r\n                }, 5);\r\n                categoryLastChild.style.boxShadow = `0px -5px 0px 0px ${primaryColor} inset`;\r\n                categoryLastChild.style.transition = 'box-shadow 0.1s ease';\r\n                break;\r\n            default:\r\n                throw new Error(`Unknown drop type: ${dropdata.type}`);\r\n        }\r\n\r\n    }\r\n\r\n    hideDropZone(dropdata, event) {\r\n\r\n        switch (dropdata.type) {\r\n            case 'item':\r\n                this.element.style.boxShadow = '';\r\n                this.element.style.transition = '';\r\n                break;\r\n            case 'category':\r\n                const itemParentId = parseInt(this.element.dataset.bookitChecklistitemCategoryid);\r\n                const categoryParentElement = document.getElementById(`bookit-master-checklist-tbody-category-${itemParentId}`);\r\n                const categoryLastChild = categoryParentElement.lastElementChild;\r\n                var isActive = parseInt(categoryParentElement.dataset.bookitCategoryActive || 0);\r\n                if (!isActive) {\r\n                    categoryLastChild.style.boxShadow = '';\r\n                    categoryLastChild.style.transition = '';\r\n                }\r\n                break;\r\n            default:\r\n                throw new Error(`Unknown drop type: ${dropdata.type}`);\r\n        }\r\n\r\n    }\r\n\r\n    _handleItemDrop(dropdata, event) {\r\n        dropdata.targetId = parseInt(this.element.dataset.bookitChecklistitemId);\r\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitChecklistitemCategoryid);\r\n\r\n        this.reactive.dispatch('reOrderCategoryItems', dropdata);\r\n\r\n        const itemObject = this.reactive.state.checklistitems.get(dropdata.id);\r\n\r\n        const itemElement = document.getElementById(`bookit-master-checklist-item-${itemObject.id}`);\r\n\r\n        const itemHasChangedParent = dropdata.parentId !== dropdata.targetParentId;\r\n\r\n        if (itemHasChangedParent) {\r\n            itemElement.dataset.bookitChecklistitemCategoryid = dropdata.targetParentId;\r\n        }\r\n\r\n        this.element.parentNode.insertBefore(itemElement, this.element.nextElementSibling);\r\n    }\r\n\r\n\r\n    _handleCategoryDrop(dropdata, event) {\r\n        const categoryElement = document.getElementById(`bookit-master-checklist-tbody-category-${dropdata.id}`);\r\n\r\n        dropdata.targetId = this.element.dataset.bookitChecklistitemCategoryid;\r\n        dropdata.targetParentId = categoryElement.dataset.bookitCategoryMasterid;\r\n\r\n        this.reactive.dispatch('reOrderCategories', dropdata);\r\n\r\n        const tableElement = document.querySelector(this.selectors.TABLE);\r\n\r\n        categoryElement.dataset.bookitCategoryActive = 1;\r\n\r\n        this.hideDropZone(dropdata, event);\r\n\r\n        tableElement.insertBefore(categoryElement, this.element.parentNode.nextElementSibling);\r\n    }\r\n\r\n\r\n    async _handleEditChecklistItemButtonClick(event) {\r\n        const modalForm = new ModalForm({\r\n            formClass: \"mod_bookit\\\\form\\\\edit_checklistitem_form\",\r\n            moduleName: 'mod_bookit/modal_delete_save_cancel',\r\n            args: {\r\n                masterid: 1,\r\n                itemid: event.currentTarget.value,\r\n                categories: Array.from(this.reactive.state.checklistcategories.values()),\r\n            },\r\n            modalConfig: {\r\n                title: await getString('checklistitem', 'mod_bookit'),\r\n            },\r\n\r\n        });\r\n\r\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (response) => {\r\n            this.reactive.stateManager.processUpdates(response.detail);\r\n\r\n            if (response.detail[0].action === 'delete') {\r\n                window.console.log('item deleted - removing & unregistering');\r\n                this.reactive.dispatch('checklistitemDeleted',\r\n                    {\r\n                        id: parseInt(response.detail[0].fields.id),\r\n                        categoryid: parseInt(this.element.dataset.bookitChecklistitemCategoryid),\r\n                    });\r\n                this.remove();\r\n                return;\r\n            }\r\n\r\n            const parentId = parseInt(this.element.dataset.bookitChecklistitemCategoryid);\r\n\r\n            const updatedParentId = parseInt(response.detail[0].fields.categoryid);\r\n\r\n            if (parentId !== updatedParentId) {\r\n\r\n                const targetParentCategoryObject = this.reactive.state.checklistcategories.get(response.detail[0].fields.categoryid);\r\n\r\n                const copiedArray = [...targetParentCategoryObject.items];\r\n\r\n                const lastItemOfParentCategoryId = copiedArray.pop();\r\n\r\n                const data = {\r\n                    id: parseInt(this.element.dataset.bookitChecklistitemId),\r\n                    type: 'item',\r\n                    parentId: parentId,\r\n                    targetId: lastItemOfParentCategoryId,\r\n                    targetParentId: updatedParentId,\r\n                }\r\n\r\n                this.reactive.dispatch('reOrderCategoryItems', data);\r\n\r\n                this.element.dataset.bookitChecklistitemCategoryid = data.targetParentId;\r\n\r\n                const targetParentElement = document.getElementById(`bookit-master-checklist-tbody-category-${data.targetParentId}`);\r\n\r\n                targetParentElement.append(this.element);\r\n            }\r\n\r\n\r\n        });\r\n\r\n        modalForm.addEventListener(modalForm.events.LOADED, (response) => {\r\n            const deleteButton = modalForm.modal.getRoot().find('button[data-action=\"delete\"]');\r\n\r\n            deleteButton.on('click', (e) => {\r\n\r\n                modalForm.getFormNode().querySelector('input[name=\"action\"]').value = 'delete';\r\n                modalForm.submitFormAjax();\r\n\r\n            });\r\n        });\r\n\r\n        modalForm.show();\r\n\r\n    }\r\n\r\n}"],"names":["BaseComponent","create","descriptor","itemEditBtnSelector","element","dataset","bookitChecklistitemId","selectors","target","this","document","querySelector","reactive","masterChecklistReactiveInstance","SELECTORS","getWatchers","stateReady","state","dragdrop","DragDrop","addEventListener","getElement","e","preventDefault","_handleEditChecklistItemButtonClick","destroy","undefined","unregister","validateDropData","dropdata","drop","event","type","_handleItemDrop","_handleCategoryDrop","Error","showDropZone","root","primaryColor","getComputedStyle","getPropertyValue","style","boxShadow","transition","itemParentId","parseInt","bookitChecklistitemCategoryid","categoryParentElement","getElementById","bookitCategoryActive","categoryLastChild","lastElementChild","setTimeout","hideDropZone","targetId","targetParentId","dispatch","itemObject","checklistitems","get","id","itemElement","parentId","parentNode","insertBefore","nextElementSibling","categoryElement","bookitCategoryMasterid","tableElement","TABLE","modalForm","ModalForm","formClass","moduleName","args","masterid","itemid","currentTarget","value","categories","Array","from","checklistcategories","values","modalConfig","title","events","FORM_SUBMITTED","response","stateManager","processUpdates","detail","action","window","console","log","fields","categoryid","remove","updatedParentId","lastItemOfParentCategoryId","items","pop","data","append","LOADED","modal","getRoot","find","on","getFormNode","submitFormAjax","show"],"mappings":"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"}