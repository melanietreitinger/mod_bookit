{"version":3,"file":"filter_dropdown.min.js","sources":["../src/filter_dropdown.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\nimport $ from 'jquery';\n\n/**\n * Frontend-only filter dropdown UI.\n * IMPORTANT: This does NOT change filter logic. It only writes into the existing selects\n * (#filter-room / #filter-faculty / #filter-status) and triggers 'change'.\n */\nexport const init = () => {\n    const root = document.querySelector('.bookit-filterdropdown');\n    if (!root) {\n        return;\n    }\n\n    const roomId = root.getAttribute('data-room-select');\n    const facultyId = root.getAttribute('data-faculty-select');\n    const statusId = root.getAttribute('data-status-select');\n\n    const selectRoom = document.getElementById(roomId);\n    const selectFaculty = document.getElementById(facultyId);\n    const selectStatus = document.getElementById(statusId);\n\n    if (!selectRoom || !selectFaculty || !selectStatus) {\n        // eslint-disable-next-line no-console\n        console.warn('[BookIT] filter_dropdown: Missing select(s)', {roomId, facultyId, statusId});\n        return;\n    }\n\n    const $toggle = $(root).find('.bookit-filterdropdown-toggle');\n    const $panel = $(root).find('.bookit-filterdropdown-panel');\n    const $cats = $(root).find('.bookit-filterdropdown-categories');\n    const $opts = $(root).find('.bookit-filterdropdown-options');\n    const $chipsInButton = $(root).find('.bookit-filterdropdown-chips');\n    const $chipsInPanel = $(root).find('.bookit-filterdropdown-activechips');\n\n   const canStatus = root.getAttribute('data-can-status') === '1';\n   const model = [\n        {key: 'room', select: selectRoom},\n        {key: 'faculty', select: selectFaculty},\n    ];\n    if (canStatus) {\n        model.push({key: 'status', select: selectStatus});\n    }\n\n\n    const isOpen = () => !$panel.prop('hidden');\n    const open = () => {\n        $panel.prop('hidden', false);\n        $toggle.attr('aria-expanded', 'true');\n    };\n    const close = () => {\n        $panel.prop('hidden', true);\n        $toggle.attr('aria-expanded', 'false');\n        $opts.empty();\n        $cats.find('.active').removeClass('active');\n    };\n\n    const getSelectedLabel = (sel) => {\n        const idx = sel.selectedIndex;\n        if (idx < 0) {\n            return '';\n        }\n        const opt = sel.options[idx];\n        return (opt && opt.value !== '') ? (opt.textContent || '') : '';\n    };\n\nconst setValueAndTrigger = (sel, value) => {\n    sel.value = value;\n    // Native event (works regardless of jQuery instances).\n    sel.dispatchEvent(new Event('change', {bubbles: true}));\n    // Also trigger via the AMD jQuery instance (keeps old behavior if listeners are jQuery-based).\n    $(sel).trigger('change');\n};\n\n    const renderChips = () => {\n        const chips = [];\n        model.forEach(({key, select}) => {\n            const label = getSelectedLabel(select);\n            if (!label) {\n                return;\n            }\n            chips.push({key, label});\n        });\n\n        const chipHtml = (chip) => `\n            <span class=\"bookit-filterchip\" data-key=\"${chip.key}\">\n                <span class=\"bookit-filterchip-label\">${escapeHtml(chip.label)}</span>\n                <button type=\"button\" class=\"bookit-filterchip-remove\" aria-label=\"Remove filter\">Ã—</button>\n            </span>\n        `;\n\n        const html = chips.map(chipHtml).join('');\n        $chipsInButton.html(html);\n        $chipsInPanel.html(html);\n    };\n\n    const buildCategories = () => {\n        $cats.empty();\n        model.forEach(({key, select}) => {\n            // Use the \"All ...\" option label as category label (no new lang strings required).\n            const label = (select.options[0] && select.options[0].textContent) ? select.options[0].textContent : key;\n\n            $cats.append(`\n                <button type=\"button\" class=\"bookit-filtercat\" data-key=\"${key}\">\n                    ${escapeHtml(label)}\n                </button>\n            `);\n        });\n    };\n\n   const buildOptionsFor = (key) => {\n        const item = model.find(x => x.key === key);\n        if (!item) {\n            return;\n        }\n\n        const sel = item.select;\n        $opts.empty();\n\n        const options = Array.from(sel.options).filter(o => o.value !== '');\n        if (!options.length) {\n            $opts.html('<div class=\"bookit-filteropt-empty\">No options</div>');\n            return;\n        }\n\n        options.forEach((o) => {\n            const active = (sel.value === o.value) ? ' active' : '';\n            $opts.append(`\n                <button type=\"button\"\n                        class=\"bookit-filteropt${active}\"\n                        data-key=\"${key}\"\n                        data-value=\"${escapeAttr(o.value)}\">\n                    ${escapeHtml(o.textContent || '')}\n                </button>\n            `);\n        });\n    };\n\n    // Toggle dropdown.\n    $toggle.on('click', (e) => {\n        e.preventDefault();\n        if (isOpen()) {\n            close();\n        } else {\n            open();\n        }\n    });\n\n    // Close on outside click.\n    $(document).on('mousedown.bookitFilterDropdown', (e) => {\n        if (isOpen() && !root.contains(e.target)) {\n            close();\n        }\n    });\n\n    // Close on ESC.\n    $(document).on('keydown.bookitFilterDropdown', (e) => {\n        if (isOpen() && e.key === 'Escape') {\n            close();\n        }\n    });\n\n    // Category click -> show options.\n    $cats.on('click', '.bookit-filtercat', function(e) {\n        e.preventDefault();\n        const key = $(this).data('key');\n        $cats.find('.active').removeClass('active');\n        $(this).addClass('active');\n        buildOptionsFor(key);\n    });\n\n    // Option click -> apply filter via underlying select, then close.\n    $opts.on('click', '.bookit-filteropt', function(e) {\n        e.preventDefault();\n\n        const key = String(this.getAttribute('data-key') || '');\n        const value = String(this.getAttribute('data-value') || '');\n\n        const item = model.find(x => x.key === key);\n        if (!item) {\n            // eslint-disable-next-line no-console\n            console.warn('[BookIT] filter_dropdown: unknown key for option click', key);\n            return;\n        }\n\n        setValueAndTrigger(item.select, value);\n        renderChips();\n        close();\n    });\n\n\n    // Chip remove (both in button and in panel).\n    $(root).on('click', '.bookit-filterchip-remove', function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const key = $(this).closest('.bookit-filterchip').data('key');\n        const item = model.find(x => x.key === key);\n        if (!item) {\n            return;\n        }\n\n        setValueAndTrigger(item.select, '');\n        renderChips();\n    });\n\n    // If selects change (from elsewhere), update chips.\n    $(selectRoom).on('change', renderChips);\n    $(selectFaculty).on('change', renderChips);\n    $(selectStatus).on('change', renderChips);\n\n    buildCategories();\n    renderChips();\n\n    // eslint-disable-next-line no-console\n    console.log('[BookIT] filter_dropdown initialized (frontend-only)');\n};\n\nconst escapeHtml = (s) => String(s)\n    .replaceAll('&', '&amp;')\n    .replaceAll('<', '&lt;')\n    .replaceAll('>', '&gt;')\n    .replaceAll('\"', '&quot;')\n    .replaceAll(\"'\", '&#039;');\n\nconst escapeAttr = (s) => escapeHtml(s);\n"],"names":["root","document","querySelector","roomId","getAttribute","facultyId","statusId","selectRoom","getElementById","selectFaculty","selectStatus","console","warn","$toggle","find","$panel","$cats","$opts","$chipsInButton","$chipsInPanel","canStatus","model","key","select","push","isOpen","prop","close","attr","empty","removeClass","setValueAndTrigger","sel","value","dispatchEvent","Event","bubbles","trigger","renderChips","chips","forEach","_ref","label","idx","selectedIndex","opt","options","textContent","getSelectedLabel","html","map","chip","escapeHtml","join","on","e","preventDefault","contains","target","this","data","addClass","item","x","Array","from","filter","o","length","active","append","escapeAttr","buildOptionsFor","String","stopPropagation","closest","_ref2","log","s","replaceAll"],"mappings":"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"}