{"version":3,"file":"filter_dropdown.min.js","sources":["../src/filter_dropdown.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\r\n\r\nimport $ from 'jquery';\r\n\r\n/**\r\n * Frontend-only filter dropdown UI.\r\n * IMPORTANT: This does NOT change filter logic. It only writes into the existing selects\r\n * (#filter-room / #filter-faculty / #filter-status) and triggers 'change'.\r\n */\r\nexport const init = () => {\r\n    const root = document.querySelector('.bookit-filterdropdown');\r\n    if (!root) {\r\n        return;\r\n    }\r\n\r\n    const roomId = root.getAttribute('data-room-select');\r\n    const facultyId = root.getAttribute('data-faculty-select');\r\n    const statusId = root.getAttribute('data-status-select');\r\n\r\n    const selectRoom = document.getElementById(roomId);\r\n    const selectFaculty = document.getElementById(facultyId);\r\n    const selectStatus = document.getElementById(statusId);\r\n\r\n    if (!selectRoom || !selectFaculty || !selectStatus) {\r\n        // eslint-disable-next-line no-console\r\n        console.warn('[BookIT] filter_dropdown: Missing select(s)', {roomId, facultyId, statusId});\r\n        return;\r\n    }\r\n\r\n    const $toggle = $(root).find('.bookit-filterdropdown-toggle');\r\n    const $panel = $(root).find('.bookit-filterdropdown-panel');\r\n    const $cats = $(root).find('.bookit-filterdropdown-categories');\r\n    const $opts = $(root).find('.bookit-filterdropdown-options');\r\n    const $chipsInButton = $(root).find('.bookit-filterdropdown-chips');\r\n    const $chipsInPanel = $(root).find('.bookit-filterdropdown-activechips');\r\n\r\n    const model = [\r\n        {key: 'room', select: selectRoom},\r\n        {key: 'faculty', select: selectFaculty},\r\n        {key: 'status', select: selectStatus},\r\n    ];\r\n\r\n    const isOpen = () => !$panel.prop('hidden');\r\n    const open = () => {\r\n        $panel.prop('hidden', false);\r\n        $toggle.attr('aria-expanded', 'true');\r\n    };\r\n    const close = () => {\r\n        $panel.prop('hidden', true);\r\n        $toggle.attr('aria-expanded', 'false');\r\n        $opts.empty();\r\n        $cats.find('.active').removeClass('active');\r\n    };\r\n\r\n    const getSelectedLabel = (sel) => {\r\n        const idx = sel.selectedIndex;\r\n        if (idx < 0) {\r\n            return '';\r\n        }\r\n        const opt = sel.options[idx];\r\n        return (opt && opt.value !== '') ? (opt.textContent || '') : '';\r\n    };\r\n\r\nconst setValueAndTrigger = (sel, value) => {\r\n    sel.value = value;\r\n    // Native event (works regardless of jQuery instances).\r\n    sel.dispatchEvent(new Event('change', {bubbles: true}));\r\n    // Also trigger via the AMD jQuery instance (keeps old behavior if listeners are jQuery-based).\r\n    $(sel).trigger('change');\r\n};\r\n\r\n    const renderChips = () => {\r\n        const chips = [];\r\n        model.forEach(({key, select}) => {\r\n            const label = getSelectedLabel(select);\r\n            if (!label) {\r\n                return;\r\n            }\r\n            chips.push({key, label});\r\n        });\r\n\r\n        const chipHtml = (chip) => `\r\n            <span class=\"bookit-filterchip\" data-key=\"${chip.key}\">\r\n                <span class=\"bookit-filterchip-label\">${escapeHtml(chip.label)}</span>\r\n                <button type=\"button\" class=\"bookit-filterchip-remove\" aria-label=\"Remove filter\">Ã—</button>\r\n            </span>\r\n        `;\r\n\r\n        const html = chips.map(chipHtml).join('');\r\n        $chipsInButton.html(html);\r\n        $chipsInPanel.html(html);\r\n    };\r\n\r\n    const buildCategories = () => {\r\n        $cats.empty();\r\n        model.forEach(({key, select}) => {\r\n            // Use the \"All ...\" option label as category label (no new lang strings required).\r\n            const label = (select.options[0] && select.options[0].textContent) ? select.options[0].textContent : key;\r\n\r\n            $cats.append(`\r\n                <button type=\"button\" class=\"bookit-filtercat\" data-key=\"${key}\">\r\n                    ${escapeHtml(label)}\r\n                </button>\r\n            `);\r\n        });\r\n    };\r\n\r\n   const buildOptionsFor = (key) => {\r\n        const item = model.find(x => x.key === key);\r\n        if (!item) {\r\n            return;\r\n        }\r\n\r\n        const sel = item.select;\r\n        $opts.empty();\r\n\r\n        const options = Array.from(sel.options).filter(o => o.value !== '');\r\n        if (!options.length) {\r\n            $opts.html('<div class=\"bookit-filteropt-empty\">No options</div>');\r\n            return;\r\n        }\r\n\r\n        options.forEach((o) => {\r\n            const active = (sel.value === o.value) ? ' active' : '';\r\n            $opts.append(`\r\n                <button type=\"button\"\r\n                        class=\"bookit-filteropt${active}\"\r\n                        data-key=\"${key}\"\r\n                        data-value=\"${escapeAttr(o.value)}\">\r\n                    ${escapeHtml(o.textContent || '')}\r\n                </button>\r\n            `);\r\n        });\r\n    };\r\n\r\n    // Toggle dropdown.\r\n    $toggle.on('click', (e) => {\r\n        e.preventDefault();\r\n        isOpen() ? close() : open();\r\n    });\r\n\r\n    // Close on outside click.\r\n    $(document).on('mousedown.bookitFilterDropdown', (e) => {\r\n        if (isOpen() && !root.contains(e.target)) {\r\n            close();\r\n        }\r\n    });\r\n\r\n    // Close on ESC.\r\n    $(document).on('keydown.bookitFilterDropdown', (e) => {\r\n        if (isOpen() && e.key === 'Escape') {\r\n            close();\r\n        }\r\n    });\r\n\r\n    // Category click -> show options.\r\n    $cats.on('click', '.bookit-filtercat', function(e) {\r\n        e.preventDefault();\r\n        const key = $(this).data('key');\r\n        $cats.find('.active').removeClass('active');\r\n        $(this).addClass('active');\r\n        buildOptionsFor(key);\r\n    });\r\n\r\n    // Option click -> apply filter via underlying select, then close.\r\n    $opts.on('click', '.bookit-filteropt', function(e) {\r\n        e.preventDefault();\r\n\r\n        const key = String(this.getAttribute('data-key') || '');\r\n        const value = String(this.getAttribute('data-value') || '');\r\n\r\n        const item = model.find(x => x.key === key);\r\n        if (!item) {\r\n            // eslint-disable-next-line no-console\r\n            console.warn('[BookIT] filter_dropdown: unknown key for option click', key);\r\n            return;\r\n        }\r\n\r\n        setValueAndTrigger(item.select, value);\r\n        renderChips();\r\n        close();\r\n    });\r\n\r\n\r\n    // Chip remove (both in button and in panel).\r\n    $(root).on('click', '.bookit-filterchip-remove', function(e) {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        const key = $(this).closest('.bookit-filterchip').data('key');\r\n        const item = model.find(x => x.key === key);\r\n        if (!item) {\r\n            return;\r\n        }\r\n\r\n        setValueAndTrigger(item.select, '');\r\n        renderChips();\r\n    });\r\n\r\n    // If selects change (from elsewhere), update chips.\r\n    $(selectRoom).on('change', renderChips);\r\n    $(selectFaculty).on('change', renderChips);\r\n    $(selectStatus).on('change', renderChips);\r\n\r\n    buildCategories();\r\n    renderChips();\r\n\r\n    // eslint-disable-next-line no-console\r\n    console.log('[BookIT] filter_dropdown initialized (frontend-only)');\r\n};\r\n\r\nconst escapeHtml = (s) => String(s)\r\n    .replaceAll('&', '&amp;')\r\n    .replaceAll('<', '&lt;')\r\n    .replaceAll('>', '&gt;')\r\n    .replaceAll('\"', '&quot;')\r\n    .replaceAll(\"'\", '&#039;');\r\n\r\nconst escapeAttr = (s) => escapeHtml(s);\r\n"],"names":["root","document","querySelector","roomId","getAttribute","facultyId","statusId","selectRoom","getElementById","selectFaculty","selectStatus","console","warn","$toggle","find","$panel","$cats","$opts","$chipsInButton","$chipsInPanel","model","key","select","isOpen","prop","close","attr","empty","removeClass","setValueAndTrigger","sel","value","dispatchEvent","Event","bubbles","trigger","renderChips","chips","forEach","_ref","label","idx","selectedIndex","opt","options","textContent","getSelectedLabel","push","html","map","chip","escapeHtml","join","on","e","preventDefault","contains","target","this","data","addClass","item","x","Array","from","filter","o","length","active","append","escapeAttr","buildOptionsFor","String","stopPropagation","closest","_ref2","log","s","replaceAll"],"mappings":"gPAsBoB,WACVA,KAAOC,SAASC,cAAc,8BAC/BF,kBAICG,OAASH,KAAKI,aAAa,oBAC3BC,UAAYL,KAAKI,aAAa,uBAC9BE,SAAWN,KAAKI,aAAa,sBAE7BG,WAAaN,SAASO,eAAeL,QACrCM,cAAgBR,SAASO,eAAeH,WACxCK,aAAeT,SAASO,eAAeF,cAExCC,aAAeE,gBAAkBC,yBAElCC,QAAQC,KAAK,8CAA+C,CAACT,OAAAA,OAAQE,UAAAA,UAAWC,SAAAA,iBAI9EO,SAAU,mBAAEb,MAAMc,KAAK,iCACvBC,QAAS,mBAAEf,MAAMc,KAAK,gCACtBE,OAAQ,mBAAEhB,MAAMc,KAAK,qCACrBG,OAAQ,mBAAEjB,MAAMc,KAAK,kCACrBI,gBAAiB,mBAAElB,MAAMc,KAAK,gCAC9BK,eAAgB,mBAAEnB,MAAMc,KAAK,sCAE7BM,MAAQ,CACV,CAACC,IAAK,OAAQC,OAAQf,YACtB,CAACc,IAAK,UAAWC,OAAQb,eACzB,CAACY,IAAK,SAAUC,OAAQZ,eAGtBa,OAAS,KAAOR,OAAOS,KAAK,UAK5BC,MAAQ,KACVV,OAAOS,KAAK,UAAU,GACtBX,QAAQa,KAAK,gBAAiB,SAC9BT,MAAMU,QACNX,MAAMF,KAAK,WAAWc,YAAY,WAYpCC,mBAAqB,CAACC,IAAKC,SAC7BD,IAAIC,MAAQA,MAEZD,IAAIE,cAAc,IAAIC,MAAM,SAAU,CAACC,SAAS,yBAE9CJ,KAAKK,QAAQ,WAGTC,YAAc,WACVC,MAAQ,GACdjB,MAAMkB,SAAQC,WAAClB,IAACA,IAADC,OAAMA,mBACXkB,MApBYV,CAAAA,YAChBW,IAAMX,IAAIY,iBACZD,IAAM,QACC,SAELE,IAAMb,IAAIc,QAAQH,YAChBE,KAAqB,KAAdA,IAAIZ,OAAiBY,IAAIE,aAAqB,IAc3CC,CAAiBxB,QAC1BkB,OAGLH,MAAMU,KAAK,CAAC1B,IAAAA,IAAKmB,MAAAA,iBAUfQ,KAAOX,MAAMY,KAPDC,wEAC8BA,KAAK7B,yEACL8B,WAAWD,KAAKV,iKAK/BY,KAAK,IACtClC,eAAe8B,KAAKA,MACpB7B,cAAc6B,KAAKA,OA8CvBnC,QAAQwC,GAAG,SAAUC,IACjBA,EAAEC,iBACFhC,SAAWE,SA9FXV,OAAOS,KAAK,UAAU,GACtBX,QAAQa,KAAK,gBAAiB,gCAiGhCzB,UAAUoD,GAAG,kCAAmCC,IAC1C/B,WAAavB,KAAKwD,SAASF,EAAEG,SAC7BhC,+BAKNxB,UAAUoD,GAAG,gCAAiCC,IACxC/B,UAAsB,WAAV+B,EAAEjC,KACdI,WAKRT,MAAMqC,GAAG,QAAS,qBAAqB,SAASC,GAC5CA,EAAEC,uBACIlC,KAAM,mBAAEqC,MAAMC,KAAK,OACzB3C,MAAMF,KAAK,WAAWc,YAAY,8BAChC8B,MAAME,SAAS,UArDGvC,CAAAA,YACdwC,KAAOzC,MAAMN,MAAKgD,GAAKA,EAAEzC,MAAQA,UAClCwC,kBAIC/B,IAAM+B,KAAKvC,OACjBL,MAAMU,cAEAiB,QAAUmB,MAAMC,KAAKlC,IAAIc,SAASqB,QAAOC,GAAiB,KAAZA,EAAEnC,QACjDa,QAAQuB,OAKbvB,QAAQN,SAAS4B,UACPE,OAAUtC,IAAIC,QAAUmC,EAAEnC,MAAS,UAAY,GACrDd,MAAMoD,yGAE+BD,uDACb/C,sDACEiD,WAAWJ,EAAEnC,0CAC7BoB,WAAWe,EAAErB,aAAe,qDAXtC5B,MAAM+B,KAAK,yDA2CfuB,CAAgBlD,QAIpBJ,MAAMoC,GAAG,QAAS,qBAAqB,SAASC,GAC5CA,EAAEC,uBAEIlC,IAAMmD,OAAOd,KAAKtD,aAAa,aAAe,IAC9C2B,MAAQyC,OAAOd,KAAKtD,aAAa,eAAiB,IAElDyD,KAAOzC,MAAMN,MAAKgD,GAAKA,EAAEzC,MAAQA,MAClCwC,MAMLhC,mBAAmBgC,KAAKvC,OAAQS,OAChCK,cACAX,SANId,QAAQC,KAAK,yDAA0DS,4BAW7ErB,MAAMqD,GAAG,QAAS,6BAA6B,SAASC,GACtDA,EAAEC,iBACFD,EAAEmB,wBAEIpD,KAAM,mBAAEqC,MAAMgB,QAAQ,sBAAsBf,KAAK,OACjDE,KAAOzC,MAAMN,MAAKgD,GAAKA,EAAEzC,MAAQA,MAClCwC,OAILhC,mBAAmBgC,KAAKvC,OAAQ,IAChCc,sCAIF7B,YAAY8C,GAAG,SAAUjB,iCACzB3B,eAAe4C,GAAG,SAAUjB,iCAC5B1B,cAAc2C,GAAG,SAAUjB,aA5GzBpB,MAAMW,QACNP,MAAMkB,SAAQqC,YAACtD,IAACA,IAADC,OAAMA,oBAEXkB,MAASlB,OAAOsB,QAAQ,IAAMtB,OAAOsB,QAAQ,GAAGC,YAAevB,OAAOsB,QAAQ,GAAGC,YAAcxB,IAErGL,MAAMqD,4FACyDhD,uCACrD8B,WAAWX,wDAwG7BJ,cAGAzB,QAAQiE,IAAI,+DAGVzB,WAAc0B,GAAML,OAAOK,GAC5BC,WAAW,IAAK,SAChBA,WAAW,IAAK,QAChBA,WAAW,IAAK,QAChBA,WAAW,IAAK,UAChBA,WAAW,IAAK,UAEfR,WAAcO,GAAM1B,WAAW0B"}